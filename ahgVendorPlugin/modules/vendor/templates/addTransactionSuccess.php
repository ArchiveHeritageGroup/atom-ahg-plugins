<?php 
$vendorsRaw = isset($sf_data) ? $sf_data->getRaw('vendors') : $vendors;
$serviceTypesRaw = isset($sf_data) ? $sf_data->getRaw('serviceTypes') : $serviceTypes;
$conditionRatingsRaw = isset($sf_data) ? $sf_data->getRaw('conditionRatings') : $conditionRatings;
$formRaw = isset($sf_data) ? $sf_data->getRaw('form') : $form;
$errorsRaw = isset($sf_data) ? $sf_data->getRaw('errors') : $errors;
?>

<div class="container-fluid px-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="<?php echo url_for('ahg_vend_index'); ?>">Vendor Management</a></li>
            <li class="breadcrumb-item"><a href="<?php echo url_for('ahg_vend_transactions'); ?>">Transactions</a></li>
            <li class="breadcrumb-item active">New Transaction</li>
        </ol>
    </nav>

    <h1 class="h2 mb-4"><i class="fas fa-plus-circle me-2"></i>New Vendor Transaction</h1>

    <?php if (!empty($errorsRaw)): ?>
    <div class="alert alert-danger">
        <ul class="mb-0">
            <?php foreach ($errorsRaw as $field => $error): ?>
            <li><?php echo esc_entities($error); ?></li>
            <?php endforeach; ?>
        </ul>
    </div>
    <?php endif; ?>

    <form method="post" action="<?php echo url_for('ahg_vend_transaction_add'); ?>" id="transactionForm">
        <div class="row">
            <div class="col-md-8">
                <!-- Basic Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>Transaction Details
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vendor *</label>
                                <select name="vendor_id" class="form-select" required>
                                    <option value="">Select vendor...</option>
                                    <?php foreach ($vendorsRaw as $vendor): ?>
                                    <option value="<?php echo $vendor->id; ?>" <?php echo ($formRaw['vendor_id'] ?? '') == $vendor->id ? 'selected' : ''; ?>>
                                        <?php echo esc_entities($vendor->name); ?>
                                    </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Service Type *</label>
                                <select name="service_type_id" class="form-select" required>
                                    <option value="">Select service...</option>
                                    <?php foreach ($serviceTypesRaw as $service): ?>
                                    <option value="<?php echo $service->id; ?>" <?php echo ($formRaw['service_type_id'] ?? '') == $service->id ? 'selected' : ''; ?>>
                                        <?php echo esc_entities($service->name); ?>
                                    </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Request Date *</label>
                                <input type="date" name="request_date" class="form-control" value="<?php echo esc_entities($formRaw['request_date'] ?? date('Y-m-d')); ?>" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Due Date</label>
                                <input type="date" name="due_date" class="form-control" value="<?php echo esc_entities($formRaw['due_date'] ?? ''); ?>">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Priority</label>
                                <select name="priority" class="form-select">
                                    <option value="normal">Normal</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2"><?php echo esc_entities($formRaw['description'] ?? ''); ?></textarea>
                        </div>
                    </div>
                </div>

                <!-- GLAM Items -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-archive me-2"></i>GLAM/DAM Items</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Search and add archival items to this transaction. You can add multiple items.
                        </div>
                        
                        <!-- Search Box -->
                        <div class="mb-3">
                            <label class="form-label">Search GLAM Items</label>
                            <div class="input-group">
                                <input type="text" id="glamSearch" class="form-control" placeholder="Type title or identifier to search..." autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="searchResults" class="autocomplete-dropdown"></div>
                        </div>

                        <!-- Selected Items Table -->
                        <div id="selectedItemsContainer">
                            <table class="table table-sm" id="selectedItemsTable" style="display: none;">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th width="120">Condition</th>
                                        <th width="120">Value (R)</th>
                                        <th width="50">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="selectedItemsBody">
                                </tbody>
                            </table>
                            <div id="noItemsMessage" class="text-center text-muted py-3">
                                <i class="fas fa-archive fa-2x mb-2"></i>
                                <p class="mb-0">No items added yet. Use the search above to add items.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-sticky-note me-2"></i>Notes
                    </div>
                    <div class="card-body">
                        <textarea name="notes" class="form-control" rows="3" placeholder="Additional notes about this transaction..."><?php echo esc_entities($formRaw['notes'] ?? ''); ?></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Cost Estimate -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-dollar-sign me-2"></i>Cost Estimate
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Estimated Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">R</span>
                                <input type="number" name="estimated_cost" class="form-control" step="0.01" value="<?php echo $formRaw['estimated_cost'] ?? ''; ?>">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-hashtag me-2"></i>Reference
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Reference Number</label>
                            <input type="text" name="reference_number" class="form-control" value="<?php echo esc_entities($formRaw['reference_number'] ?? ''); ?>" placeholder="Optional external reference">
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Create Transaction
                            </button>
                            <a href="<?php echo url_for('ahg_vend_transactions'); ?>" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style <?php $n = sfConfig::get('csp_nonce', ''); echo $n ? preg_replace('/^nonce=/', 'nonce="', $n).'"' : ''; ?>>
.autocomplete-dropdown {
    position: absolute;
    z-index: 1050;
    width: calc(100% - 2rem);
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    display: none;
}
.autocomplete-dropdown .ac-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}
.autocomplete-dropdown .ac-item:hover {
    background-color: #e9ecef;
}
.autocomplete-dropdown .ac-item:last-child {
    border-bottom: none;
}
.autocomplete-dropdown .ac-item .ac-title {
    font-weight: 500;
}
.autocomplete-dropdown .ac-item .ac-meta {
    font-size: 0.85em;
    color: #6c757d;
}
</style>

<script <?php $n = sfConfig::get('csp_nonce', ''); echo $n ? preg_replace('/^nonce=/', 'nonce="', $n).'"' : ''; ?>>
let selectedItems = [];
let searchTimeout;

// Condition ratings from PHP
const conditionRatings = <?php echo json_encode($conditionRatingsRaw); ?>;

document.getElementById('glamSearch').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch('/index.php/api/autocomplete/glam?q=' + encodeURIComponent(query))
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    let html = '';
                    data.forEach(item => {
                        // Check if already selected
                        const isSelected = selectedItems.some(s => s.id === item.id);
                        if (!isSelected) {
                            html += `<div class="ac-item" onclick='addItem(${JSON.stringify(item)})'>
                                <div class="ac-title">${escapeHtml(item.value)}</div>
                                <div class="ac-meta">
                                    ${item.identifier ? '<code>' + escapeHtml(item.identifier) + '</code> â€¢ ' : ''}
                                    ${item.level ? '<span class="badge bg-secondary">' + escapeHtml(item.level) + '</span>' : ''}
                                </div>
                            </div>`;
                        }
                    });
                    if (html) {
                        resultsDiv.innerHTML = html;
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.innerHTML = '<div class="ac-item text-muted">All matching items already added</div>';
                        resultsDiv.style.display = 'block';
                    }
                } else {
                    resultsDiv.innerHTML = '<div class="ac-item text-muted">No results found</div>';
                    resultsDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsDiv.style.display = 'none';
            });
    }, 300);
});

function addItem(item) {
    selectedItems.push(item);
    renderSelectedItems();
    document.getElementById('glamSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
}

function removeItem(id) {
    selectedItems = selectedItems.filter(item => item.id !== id);
    renderSelectedItems();
}

function renderSelectedItems() {
    const tbody = document.getElementById('selectedItemsBody');
    const table = document.getElementById('selectedItemsTable');
    const noItemsMsg = document.getElementById('noItemsMessage');
    
    if (selectedItems.length === 0) {
        table.style.display = 'none';
        noItemsMsg.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    noItemsMsg.style.display = 'none';
    
    let conditionOptions = '<option value="">Select...</option>';
    for (const [key, label] of Object.entries(conditionRatings)) {
        conditionOptions += `<option value="${key}">${label}</option>`;
    }
    
    tbody.innerHTML = selectedItems.map((item, idx) => `
        <tr>
            <td>
                <input type="hidden" name="information_object_ids[]" value="${item.id}">
                <strong>${escapeHtml(item.value)}</strong><br>
                <small class="text-muted">${item.identifier ? escapeHtml(item.identifier) : ''}</small>
            </td>
            <td>
                <select name="condition_ratings[]" class="form-select form-select-sm">
                    ${conditionOptions}
                </select>
            </td>
            <td>
                <input type="number" name="declared_values[]" class="form-control form-control-sm" step="0.01" placeholder="0.00">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function clearSearch() {
    document.getElementById('glamSearch').value = '';
    document.getElementById('searchResults').style.display = 'none';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close dropdown on click outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#glamSearch') && !e.target.closest('#searchResults')) {
        document.getElementById('searchResults').style.display = 'none';
    }
});

// Keyboard navigation
document.getElementById('glamSearch').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('searchResults').style.display = 'none';
    }
});
</script>
