<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; background: #1a1a1a; }
        #viewer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="viewer"></div>
    <div id="loading">Loading...</div>
    <script src="openseadragon.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const iiif = params.get('iiif');
        const manifestUrl = params.get('manifest');

        function initViewer(tileSources) {
            document.getElementById('loading').remove();
            OpenSeadragon({
                id: 'viewer',
                prefixUrl: '/plugins/ahgIiifPlugin/web/images/',
                tileSources: tileSources,
                showNavigator: true,
                navigatorPosition: 'BOTTOM_RIGHT',
                showRotationControl: true,
                showFlipControl: true,
                gestureSettingsMouse: { scrollToZoom: true },
                crossOriginPolicy: 'Anonymous',
                sequenceMode: tileSources.length > 1,
                showReferenceStrip: tileSources.length > 1
            });
        }

        if (iiif) {
            initViewer([iiif + '/info.json']);
        } else if (manifestUrl) {
            fetch(manifestUrl)
                .then(r => r.json())
                .then(manifest => {
                    const tileSources = [];
                    const sequences = manifest.sequences || [];
                    for (const seq of sequences) {
                        for (const canvas of (seq.canvases || [])) {
                            for (const image of (canvas.images || [])) {
                                const service = image.resource && image.resource.service;
                                if (service) {
                                    const serviceId = service['@id'] || service.id;
                                    if (serviceId) {
                                        tileSources.push(serviceId + '/info.json');
                                    }
                                }
                            }
                        }
                    }
                    if (tileSources.length > 0) {
                        initViewer(tileSources);
                    } else {
                        document.getElementById('loading').textContent = 'No images found in manifest';
                    }
                })
                .catch(err => {
                    document.getElementById('loading').textContent = 'Failed to load manifest: ' + err.message;
                });
        } else {
            document.getElementById('loading').textContent = 'No image source specified. Use ?manifest= or ?iiif= parameter.';
        }
    </script>
</body>
</html>
