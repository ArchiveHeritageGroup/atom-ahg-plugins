<?php use_helper('Text') ?>

<div class="container-fluid py-3">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="<?php echo url_for(['module' => 'informationobject', 'slug' => $resource->slug]) ?>"><?php echo $resource->title ?? $resource->slug ?></a></li>
      <li class="breadcrumb-item"><a href="<?php echo url_for(['module' => 'provenance', 'action' => 'view', 'slug' => $resource->slug]) ?>">Provenance</a></li>
      <li class="breadcrumb-item active">Timeline</li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1"><i class="bi bi-bar-chart-steps me-2"></i>Provenance Timeline</h4>
      <p class="text-muted mb-0"><?php echo $resource->title ?? $resource->slug ?></p>
    </div>
    <div>
      <a href="<?php echo url_for(['module' => 'provenance', 'action' => 'view', 'slug' => $resource->slug]) ?>" class="btn btn-outline-secondary me-2">
        <i class="bi bi-arrow-left me-1"></i>Back to Provenance
      </a>
      <?php if ($sf_user->isAuthenticated()): ?>
      <a href="<?php echo url_for(['module' => 'provenance', 'action' => 'edit', 'slug' => $resource->slug]) ?>" class="btn btn-primary">
        <i class="bi bi-pencil me-1"></i> Edit Provenance
      </a>
      <?php endif ?>
    </div>
  </div>

  <!-- Timeline Visualization -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-calendar-range me-2"></i>
        <?php echo __('Visual Timeline') ?>
      </h5>
    </div>
    <div class="card-body">
      <div id="timeline-container" style="width: 100%; min-height: 400px; overflow-x: auto;">
        <svg id="provenance-timeline"></svg>
      </div>
      <div class="mt-3">
        <div class="d-flex flex-wrap gap-2">
          <span class="badge" style="background-color: #4caf50;">Creation</span>
          <span class="badge" style="background-color: #2196f3;">Sale/Purchase</span>
          <span class="badge" style="background-color: #9c27b0;">Gift/Donation</span>
          <span class="badge" style="background-color: #ff9800;">Inheritance</span>
          <span class="badge" style="background-color: #f44336;">Auction</span>
          <span class="badge" style="background-color: #607d8b;">Transfer</span>
          <span class="badge" style="background-color: #795548;">Loan</span>
          <span class="badge" style="background-color: #9e9e9e;">Other</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Events Table -->
  <?php 
  $rawTimeline = $provenance['timeline'];
  if ($rawTimeline instanceof sfOutputEscaperArrayDecorator) {
      $rawTimeline = $rawTimeline->getRawValue();
  }
  ?>
  <?php if (!empty($rawTimeline)): ?>
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-list-ul me-2"></i>
        <?php echo __('Provenance Events') ?>
      </h5>
      <span class="badge bg-secondary"><?php echo count($rawTimeline) ?></span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th><?php echo __('Type') ?></th>
              <th><?php echo __('Date') ?></th>
              <th><?php echo __('From') ?></th>
              <th><?php echo __('To') ?></th>
              <th><?php echo __('Location') ?></th>
              <th><?php echo __('Certainty') ?></th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($rawTimeline as $event): ?>
            <tr>
              <td><span class="badge bg-primary"><?php echo htmlspecialchars($event['type_label'] ?? '') ?></span></td>
              <td><?php echo htmlspecialchars($event['date_display'] ?? '') ?></td>
              <td><?php echo htmlspecialchars($event['from'] ?? '-') ?></td>
              <td><?php echo htmlspecialchars($event['to'] ?? '-') ?></td>
              <td><?php echo htmlspecialchars($event['location'] ?? '-') ?></td>
              <td>
                <?php 
                $cert = $event['certainty'] ?? 'unknown';
                $certClass = $cert === 'certain' ? 'success' : ($cert === 'uncertain' ? 'warning' : 'secondary');
                ?>
                <span class="badge bg-<?php echo $certClass ?>"><?php echo ucfirst($cert) ?></span>
              </td>
            </tr>
            <?php endforeach ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <?php else: ?>
  <div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    No provenance events have been recorded.
    <?php if ($sf_user->isAuthenticated()): ?>
    <a href="<?php echo url_for(['module' => 'provenance', 'action' => 'edit', 'slug' => $resource->slug]) ?>" class="alert-link">Add events</a>
    <?php endif ?>
  </div>
  <?php endif ?>
</div>

<!-- D3.js Timeline -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script <?php $n = sfConfig::get('csp_nonce', ''); echo $n ? preg_replace('/^nonce=/', 'nonce="', $n).'"' : ''; ?>>
document.addEventListener('DOMContentLoaded', function() {
  const timelineData = <?php echo $sf_data->getRaw('timelineData') ?>;
  
  const categoryColors = {
    'creation': '#4caf50',
    'sale': '#2196f3',
    'gift': '#9c27b0',
    'inheritance': '#ff9800',
    'auction': '#f44336',
    'transfer': '#607d8b',
    'loan': '#795548',
    'theft': '#e91e63',
    'recovery': '#00bcd4',
    'event': '#9e9e9e'
  };

  if (timelineData.length === 0) {
    document.getElementById('timeline-container').innerHTML =
      '<div class="alert alert-info mb-0"><i class="bi bi-info-circle me-2"></i>No events to display in timeline.</div>';
    return;
  }

  // Parse dates
  const parseDate = d3.timeParse('%Y-%m-%d');
  timelineData.forEach(d => {
    d.startDateParsed = d.startDate ? parseDate(d.startDate) : null;
  });

  const validData = timelineData.filter(d => d.startDateParsed);
  const container = document.getElementById('timeline-container');
  const margin = { top: 40, right: 200, bottom: 60, left: 60 };
  const width = Math.max(900, container.clientWidth) - margin.left - margin.right;
  
  if (validData.length === 0) {
    // Non-dated events - horizontal bars
    const barHeight = 45;
    const height = timelineData.length * barHeight + margin.top + margin.bottom;
    
    const svg = d3.select('#provenance-timeline')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height);
    
    const g = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);
    
    const y = d3.scaleBand()
      .domain(timelineData.map((d, i) => i))
      .range([0, timelineData.length * barHeight])
      .padding(0.2);
    
    // Bars
    g.selectAll('.event-bar')
      .data(timelineData)
      .enter()
      .append('rect')
      .attr('class', 'event-bar')
      .attr('x', 0)
      .attr('y', (d, i) => y(i))
      .attr('width', width)
      .attr('height', y.bandwidth())
      .attr('fill', d => categoryColors[d.category] || categoryColors.event)
      .attr('opacity', 0.85)
      .attr('rx', 6);
    
    // Type labels (left)
    g.selectAll('.type-label')
      .data(timelineData)
      .enter()
      .append('text')
      .attr('x', 15)
      .attr('y', (d, i) => y(i) + y.bandwidth() / 2 + 5)
      .text(d => d.type)
      .attr('fill', '#fff')
      .attr('font-size', '14px')
      .attr('font-weight', 'bold');
    
    // Agent/details labels (right)
    g.selectAll('.detail-label')
      .data(timelineData)
      .enter()
      .append('text')
      .attr('x', width - 15)
      .attr('y', (d, i) => y(i) + y.bandwidth() / 2 + 5)
      .attr('text-anchor', 'end')
      .text(d => {
        let parts = [];
        if (d.from) parts.push(d.from);
        if (d.to) parts.push('→ ' + d.to);
        if (d.location) parts.push('@ ' + d.location);
        return parts.join(' ') || d.label;
      })
      .attr('fill', '#fff')
      .attr('font-size', '12px');
    
    return;
  }

  // Timeline with dates
  const height = Math.max(350, validData.length * 60);
  
  const svg = d3.select('#provenance-timeline')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom);
  
  const g = svg.append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);
  
  // X scale (time)
  const xExtent = d3.extent(validData, d => d.startDateParsed);
  const x = d3.scaleTime()
    .domain([d3.timeYear.offset(xExtent[0], -2), d3.timeYear.offset(xExtent[1] || new Date(), 2)])
    .range([0, width]);
  
  // Y scale
  const y = d3.scaleBand()
    .domain(validData.map((d, i) => i))
    .range([0, height - margin.top - margin.bottom])
    .padding(0.4);
  
  // Grid lines
  g.append('g')
    .attr('class', 'grid')
    .selectAll('line')
    .data(x.ticks(10))
    .enter()
    .append('line')
    .attr('x1', d => x(d))
    .attr('x2', d => x(d))
    .attr('y1', 0)
    .attr('y2', height - margin.top - margin.bottom)
    .attr('stroke', '#e0e0e0')
    .attr('stroke-dasharray', '3,3');
  
  // X axis
  g.append('g')
    .attr('transform', `translate(0,${height - margin.top - margin.bottom})`)
    .call(d3.axisBottom(x).ticks(10).tickFormat(d3.timeFormat('%Y')))
    .selectAll('text')
    .attr('font-size', '11px');
  
  // Event bars
  g.selectAll('.event-bar')
    .data(validData)
    .enter()
    .append('rect')
    .attr('class', 'event-bar')
    .attr('x', d => x(d.startDateParsed) - 3)
    .attr('y', (d, i) => y(i))
    .attr('width', 6)
    .attr('height', y.bandwidth())
    .attr('fill', d => categoryColors[d.category] || categoryColors.event)
    .attr('rx', 3);
  
  // Event circles
  g.selectAll('.event-marker')
    .data(validData)
    .enter()
    .append('circle')
    .attr('class', 'event-marker')
    .attr('cx', d => x(d.startDateParsed))
    .attr('cy', (d, i) => y(i) + y.bandwidth() / 2)
    .attr('r', 12)
    .attr('fill', d => categoryColors[d.category] || categoryColors.event)
    .attr('stroke', '#fff')
    .attr('stroke-width', 3);
  
  // Labels
  g.selectAll('.event-label')
    .data(validData)
    .enter()
    .append('text')
    .attr('x', d => x(d.startDateParsed) + 20)
    .attr('y', (d, i) => y(i) + y.bandwidth() / 2 + 5)
    .text(d => {
      let text = d.type;
      if (d.from || d.to) {
        text += ': ';
        if (d.from) text += d.from;
        if (d.from && d.to) text += ' → ';
        if (d.to) text += d.to;
      }
      return text;
    })
    .attr('font-size', '12px')
    .attr('fill', '#333');
  
  // Date labels
  g.selectAll('.date-label')
    .data(validData)
    .enter()
    .append('text')
    .attr('x', d => x(d.startDateParsed))
    .attr('y', (d, i) => y(i) - 5)
    .attr('text-anchor', 'middle')
    .text(d => d.startDate)
    .attr('font-size', '10px')
    .attr('fill', '#666');
});
</script>

<style <?php $n = sfConfig::get('csp_nonce', ''); echo $n ? preg_replace('/^nonce=/', 'nonce="', $n).'"' : ''; ?>>
.event-bar {
  transition: opacity 0.2s;
}
.event-bar:hover {
  opacity: 1 !important;
}
.event-marker {
  cursor: pointer;
  transition: r 0.2s;
}
.event-marker:hover {
  r: 15;
}
</style>
