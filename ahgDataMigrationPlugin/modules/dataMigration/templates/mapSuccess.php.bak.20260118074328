<?php use_helper('Date') ?>
<?php
$rawMappings = $sf_data->getRaw('savedMappings');
if (!is_array($rawMappings)) $rawMappings = [];
?>

<div class="container-fluid py-3">
  <!-- Header -->
  <div class="row mb-3">
    <div class="col">
      <h4>‚áÑ Field Mapping: <?php echo htmlspecialchars($filename) ?></h4>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-2 mb-3">
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body py-2">
          <h6 class="text-muted mb-1">üìÑ File</h6>
          <strong><?php echo count($detection['rows'] ?? []) ?> rows</strong>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body py-2">
          <h6 class="text-muted mb-1">üéØ Target</h6>
          <strong><?php echo htmlspecialchars($targetTypeLabels[$targetType] ?? $targetType) ?></strong>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body py-2">
          <h6 class="text-muted mb-1">üìã Source Fields</h6>
          <strong><?php echo count($sourceFields) ?> columns</strong>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body py-2">
          <h6 class="text-muted mb-1">‚öô Output Mode</h6>
          <div class="btn-group w-100 mb-2" role="group" id="modeToggle">
            <button type="button" class="btn btn-sm btn-primary active" data-mode="standard" id="btnStandardMode">
              <i class="bi bi-file-text me-1"></i>Standard ISAD
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" data-mode="ahg" id="btnAhgMode">
              <i class="bi bi-puzzle me-1"></i>AHG Extended
            </button>
          </div>
          <select id="outputMode" class="form-select form-select-sm">
            <option value="preview">Preview Only</option>
            <option value="import">Import to Database</option>
            <option value="csv">Export to AtoM CSV</option>
            <option value="ead">Export to EAD 2002</option>
            <option value="ahg_csv" class="ahg-option">Export to AHG Extended CSV</option>
            <option value="ahg_import" class="ahg-option">Direct AHG Import (with plugins)</option>
          </select>
          <button type="button" class="btn btn-primary w-100 mt-2" id="topPreviewBtn" onclick="document.getElementById('mappingForm').submit();">
            <i class="bi bi-play-fill me-1"></i> Preview / Import
          </button>
        </div>
      </div>
    </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body py-2">
          <h6 class="text-muted mb-1">üéØ Target Sector (for CSV)</h6>
          <select id="targetSector" class="form-select form-select-sm">
            <option value="archives">Archives (ISAD-G)</option>
            <option value="museum">Museum (Spectrum)</option>
            <option value="library">Library (MARC)</option>
            <option value="gallery">Gallery (CCO)</option>
            <option value="dam">DAM (Dublin Core)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- AHG Extended Fields Info -->
  <div class="alert alert-info py-2 mb-3 small" id="ahgFieldsInfo">
    <div class="d-flex align-items-center">
      <i class="bi bi-info-circle me-2 fs-5"></i>
      <div>
        <strong>AHG Extended Fields:</strong> When using standard export modes (CSV, EAD, Import), 
        AHG source fields like <code>ahgProvenanceHistory</code> will map to standard ISAD fields 
        (e.g., Archival History). For full AHG plugin integration, select <strong>"AHG Extended CSV"</strong> 
        or <strong>"Direct AHG Import"</strong> output mode.
      </div>
    </div>
  </div>

  <!-- Data Preview Section -->
  <?php $rawDetection = $sf_data->getRaw('detection'); ?>
  <?php $rawSourceFields = $sf_data->getRaw('sourceFields'); ?>
  <div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center bg-info text-white">
      <h6 class="mb-0"><i class="bi bi-eye"></i> Source Data Preview</h6>
      <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#dataPreviewCollapse">
        Toggle Preview
      </button>
    </div>
    <div class="collapse show" id="dataPreviewCollapse">
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
          <table class="table table-sm table-bordered table-striped mb-0" style="font-size: 0.75rem;">
            <thead class="table-dark sticky-top">
              <tr>
                <th class="text-center" style="width: 40px;">#</th>
                <?php foreach ($rawSourceFields as $field): ?>
                <th class="text-nowrap"><?php echo htmlspecialchars($field) ?></th>
                <?php endforeach ?>
              </tr>
            </thead>
            <tbody>
              <?php 
              $previewRows = array_slice($rawDetection['rows'] ?? [], 0, 5);
              foreach ($previewRows as $rowIndex => $row): 
              ?>
              <tr>
                <td class="text-center text-muted"><?php echo $rowIndex + 1 ?></td>
                <?php foreach ($rawSourceFields as $colIndex => $field): ?>
                <td class="text-truncate" style="max-width: 200px;" title="<?php echo htmlspecialchars($row[$colIndex] ?? '') ?>">
                  <?php echo htmlspecialchars(mb_substr($row[$colIndex] ?? '', 0, 80)) ?>
                  <?php if (strlen($row[$colIndex] ?? '') > 80): ?>...<?php endif ?>
                </td>
                <?php endforeach ?>
              </tr>
              <?php endforeach ?>
            </tbody>
          </table>
        </div>
        <div class="card-footer py-1 small text-muted">
          Showing first <?php echo count($previewRows) ?> of <?php echo count($rawDetection['rows'] ?? []) ?> rows
        </div>
      </div>
    </div>
  </div>

  <!-- Mapping Controls -->
  <div class="card mb-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
      <h6 class="mb-0">üîß Mapping Controls</h6>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-primary" id="loadMappingBtn">
          üìÇ Load Mapping
        </button>
        <button type="button" class="btn btn-outline-success" id="saveMappingBtn">
          üíæ Save Mapping
        </button>
        <button type="button" class="btn btn-outline-secondary" id="selectAllInclude">
          ‚úì All
        </button>
        <button type="button" class="btn btn-outline-secondary" id="deselectAllInclude">
          ‚úó None
        </button>
        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#digitalObjectHelpModal">
          üì∑ Digital Objects Help
        </button>
      </div>
    </div>
  </div>

  <!-- Mapping Form -->
  <form action="<?php echo url_for(['module' => 'dataMigration', 'action' => 'preview']) ?>" method="post" id="mappingForm">
    <input type="hidden" id="currentMappingId" name="current_mapping_id" value="<?php echo isset($loadedMappingId) ? $loadedMappingId : '' ?>">
    <input type="hidden" name="target_type" value="<?php echo htmlspecialchars($targetType) ?>">
    <input type="hidden" name="output_mode" id="outputModeInput" value="preview">
    <input type="hidden" name="target_sector" id="targetSectorInput" value="archives">

    <div class="card">
      <div class="card-header bg-primary text-white py-2">
        <div class="row align-items-center small">
          <div class="col-2"><strong>Source Field</strong></div>
          <div class="col-2"><strong>AtoM Field</strong></div>
          <div class="col-2"><strong>Constant</strong></div>
          <div class="col-1 text-center"><strong>Prepend</strong></div>
          <div class="col-1 text-center"><strong>Concat</strong></div>
          <div class="col-2"><strong>Symbol</strong></div>
          <div class="col-1 text-center"><strong>Include</strong></div>
          <div class="col-1"><strong>Transform</strong></div>
        </div>
      </div>
      <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto;">
        <table class="table table-striped table-hover table-sm mb-0" id="mappingTable">
          <tbody>
            <?php 
            $lastCategory = "";
            $categoryLabels = [
              "standard" => "Standard Fields",
              "security" => "üîí Security & Access",
              "rights" => "‚öñÔ∏è Rights & Licensing",
              "provenance" => "üìú Provenance & History",
              "digital" => "üìÅ Digital Objects",
              "transfer" => "üì¶ Transfer Metadata"
            ];
            function getFieldCategory($field) {
              $f = strtolower($field);
              if (strpos($f, "security") !== false || strpos($f, "access") !== false && strpos($f, "accesspoint") === false) return "security";
              if (strpos($f, "right") !== false || strpos($f, "license") !== false || strpos($f, "copyright") !== false) return "rights";
              if (strpos($f, "provenance") !== false || strpos($f, "history") !== false && strpos($f, "archival") === false) return "provenance";
              if (strpos($f, "filename") !== false || strpos($f, "digitalobject") !== false || strpos($f, "checksum") !== false || strpos($f, "mime") !== false) return "digital";
              if (strpos($f, "transfer") !== false || strpos($f, "manifest") !== false) return "transfer";
              return "standard";
            }
            ?>
            <?php foreach ($mappingRows as $i => $row): ?>
            <?php 
            $currentCategory = getFieldCategory($row["source_field"]);
            if ($currentCategory !== $lastCategory && $currentCategory !== "standard"):
            ?>
            <tr class="table-secondary">
              <td colspan="8" class="py-1 ps-3 fw-bold small">
                <?php echo $categoryLabels[$currentCategory] ?? ucfirst($currentCategory) ?>
              </td>
            </tr>
            <?php 
            $lastCategory = $currentCategory;
            endif;
            ?>
            <tr data-row="<?php echo $i ?>">
              <td style="width:16%">
                <input type="hidden" name="fields[<?php echo $i ?>][source_field]" value="<?php echo htmlspecialchars($row['source_field']) ?>">
                <code class="small"><?php echo htmlspecialchars($row['source_field']) ?></code>
              </td>
              <td style="width:16%">
                <select name="fields[<?php echo $i ?>][atom_field]" class="form-select form-select-sm atom-field-select">
                  <option value="">-- Skip --</option>
                  <optgroup label="Standard ISAD-G Fields">
                  <?php foreach ($targetFields as $key => $label): ?>
                    <?php if (strpos($key, "ahg") !== 0 && $key !== "Filename" && strpos($key, "digitalObject") !== 0 || $key === "digitalObjectPath" || $key === "digitalObjectURI"): ?>
                    <option value="<?php echo $key ?>" <?php echo ($row["atom_field"] === $key) ? "selected" : "" ?>>
                      <?php echo htmlspecialchars($label) ?>
                    </option>
                    <?php endif ?>
                  <?php endforeach ?>
                  </optgroup>
                  <optgroup label="‚îÄ‚îÄ‚îÄ AHG Extended Fields ‚îÄ‚îÄ‚îÄ" class="ahg-fields-group">
                  <?php foreach ($targetFields as $key => $label): ?>
                    <?php if (strpos($key, "ahg") === 0 || ($key === "Filename" || (strpos($key, "digitalObject") === 0 && $key !== "digitalObjectPath" && $key !== "digitalObjectURI"))): ?>
                    <option value="<?php echo $key ?>" <?php echo ($row["atom_field"] === $key) ? "selected" : "" ?>>
                      <?php echo htmlspecialchars($label) ?>
                    </option>
                    <?php endif ?>
                  <?php endforeach ?>
                  </optgroup>
                </select>
              </td>
              <td style="width:16%">
                <input type="text" name="fields[<?php echo $i ?>][constant_value]"
                       value="<?php echo htmlspecialchars($row['constant_value']) ?>"
                       class="form-control form-control-sm" placeholder="Constant...">
              </td>
              <td style="width:8%" class="text-center">
                <input type="checkbox" name="fields[<?php echo $i ?>][concat_constant]" value="1"
                       class="form-check-input" <?php echo $row['concat_constant'] ? 'checked' : '' ?>>
              </td>
              <td style="width:8%" class="text-center">
                <input type="checkbox" name="fields[<?php echo $i ?>][concatenate]" value="1"
                       class="form-check-input" <?php echo $row['concatenate'] ? 'checked' : '' ?>>
              </td>
              <td style="width:16%">
                <select name="fields[<?php echo $i ?>][concat_symbol]" class="form-select form-select-sm">
                  <option value="|" <?php echo ($row['concat_symbol'] === '|') ? 'selected' : '' ?>>| (Pipe)</option>
                  <option value="\n" <?php echo ($row['concat_symbol'] === '\n' || $row['concat_symbol'] === "\n") ? 'selected' : '' ?>>‚Üµ (Newline)</option>
                  <option value="; " <?php echo ($row['concat_symbol'] === '; ') ? 'selected' : '' ?>>; (Semicolon)</option>
                  <option value=", " <?php echo ($row['concat_symbol'] === ', ') ? 'selected' : '' ?>>, (Comma)</option>
                  <option value=" - " <?php echo ($row['concat_symbol'] === ' - ') ? 'selected' : '' ?>>- (Dash)</option>
                  <option value=" " <?php echo ($row['concat_symbol'] === ' ') ? 'selected' : '' ?>>Space</option>
                </select>
              </td>
              <td style="width:8%" class="text-center">
                <input type="checkbox" name="fields[<?php echo $i ?>][include]" value="1"
                       class="form-check-input include-check" <?php echo $row['include'] ? 'checked' : '' ?>>
              </td>
              <td style="width:8%">
                <select name="fields[<?php echo $i ?>][transform]" class="form-select form-select-sm transform-select">
                  <option value="">None</option>
                  <option value="filename">Filename only</option>
                  <option value="lowercase">Lowercase</option>
                  <option value="prefix">Add prefix</option>
                  <option value="replace">Replace path</option>
                </select>
              </td>
            </tr>
            <?php endforeach ?>
            <!-- Custom Field Rows (user-added) -->
            <tr id="addFieldRow" class="table-light">
              <td colspan="8" class="text-center py-2">
                <button type="button" class="btn btn-sm btn-outline-success" id="addCustomFieldBtn">
                  <i class="bi bi-plus-circle me-1"></i> Add Custom Field
                </button>
                <small class="text-muted ms-2">Add fields not in source (e.g., culture, language, script)</small>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="card-footer">
        <div class="d-flex justify-content-between">
          <a href="<?php echo url_for(['module' => 'dataMigration', 'action' => 'index']) ?>" class="btn btn-secondary">
            ‚Üê Back
          </a>
          <button type="submit" class="btn btn-primary" name="action" value="preview">
            <i class="bi bi-play-fill me-1"></i> Preview / Import
          </button>
          <button type="button" class="btn btn-success" id="backgroundJobBtn" title="Process large files in background without timeout">
            <i class="bi bi-cloud-upload me-1"></i> Background Job
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Load Mapping Modal -->
<div class="modal fade" id="loadMappingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">üìÇ Load Saved Mapping</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <table class="table table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Mapping Name</th>
              <th>Type</th>
              <th>Fields</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <?php if (empty($rawMappings)): ?>
              <tr><td colspan="4" class="text-muted text-center py-3">No saved mappings</td></tr>
            <?php else: ?>
              <?php foreach ($rawMappings as $mapping): 
                $fields = json_decode($mapping->field_mappings, true);
                $fieldCount = isset($fields['fields']) ? count($fields['fields']) : 0;
              ?>
                <tr>
                  <td><strong><?php echo htmlspecialchars($mapping->name) ?></strong></td>
                  <td><small class="text-muted"><?php echo htmlspecialchars($mapping->target_type ?? '') ?></small></td>
                  <td><span class="badge bg-info"><?php echo $fieldCount ?></span></td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-success load-mapping-btn" data-id="<?php echo $mapping->id ?>">
                        ‚úì Load
                      </button>
                      <button type="button" class="btn btn-outline-secondary rename-btn" 
                              data-id="<?php echo $mapping->id ?>" 
                              data-name="<?php echo htmlspecialchars($mapping->name) ?>">
                        ‚úé
                      </button>
                      <button type="button" class="btn btn-outline-danger delete-btn" 
                              data-id="<?php echo $mapping->id ?>" 
                              data-name="<?php echo htmlspecialchars($mapping->name) ?>">
                        ‚úï
                      </button>
                    </div>
                  </td>
                </tr>
              <?php endforeach ?>
            <?php endif ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Save Mapping Modal -->
<div class="modal fade" id="saveMappingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header py-2 bg-success text-white">
        <h6 class="modal-title"><i class="bi bi-save me-2"></i>Save Mapping</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Left: File browser -->
          <div class="col-md-6">
            <label class="form-label fw-bold"><i class="bi bi-folder me-1"></i>Existing Mappings</label>
            <div class="border rounded bg-light" style="height: 280px; overflow-y: auto;">
              <?php
              $groupedMappings = [];
              foreach ($rawMappings as $m) {
                  $cat = $m->category ?? "Custom";
                  if (!isset($groupedMappings[$cat])) $groupedMappings[$cat] = [];
                  $groupedMappings[$cat][] = $m;
              }
              ksort($groupedMappings);
              ?>
              <div class="list-group list-group-flush" id="mappingBrowser">
                <?php foreach ($groupedMappings as $category => $mappings): ?>
                <div class="list-group-item bg-secondary text-white py-1 px-2 small">
                  <i class="bi bi-folder-fill text-warning me-1"></i><?php echo htmlspecialchars($category) ?>
                </div>
                <?php foreach ($mappings as $mapping): ?>
                <a href="javascript:void(0)" class="list-group-item list-group-item-action py-1 px-3 mapping-select-item"
                   data-id="<?php echo $mapping->id ?>"
                   data-name="<?php echo htmlspecialchars($mapping->name) ?>"
                   data-category="<?php echo htmlspecialchars($category) ?>"
                   data-default="<?php echo $mapping->is_default ? 1 : 0 ?>">
                  <i class="bi bi-file-earmark-text me-1 text-muted"></i>
                  <?php echo htmlspecialchars($mapping->name) ?>
                  <?php if ($mapping->is_default): ?><span class="badge bg-primary ms-1">Default</span><?php endif ?>
                </a>
                <?php endforeach ?>
                <?php endforeach ?>
                <?php if (empty($groupedMappings)): ?>
                <div class="text-muted text-center py-4"><i class="bi bi-inbox"></i> No saved mappings</div>
                <?php endif ?>
              </div>
            </div>
            <small class="text-muted">Click to select for overwrite</small>
          </div>
          <!-- Right: Save form -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Mapping Name <span class="text-danger">*</span></label>
              <input type="text" id="mappingName" class="form-control" placeholder="Enter mapping name...">
              <input type="hidden" id="selectedMappingId" value="">
            </div>
            <div class="mb-3">
              <label class="form-label">Category</label>
              <select id="mappingCategory" class="form-select">
                <option value="Custom">Custom</option>
                <option value="ArchivesSpace">ArchivesSpace</option>
                <option value="Preservica">Preservica</option>
                <option value="Vernon">Vernon CMS</option>
                <option value="PSIS">PSIS</option>
                <option value="DAM">DAM / Digital Assets</option>
                <option value="WDB">WDB</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Target Type</label>
              <select id="mappingTargetType" class="form-select">
                <option value="archives">Archives (ISAD-G)</option>
                <option value="library">Library</option>
                <option value="museum">Museum (Spectrum)</option>
                <option value="gallery">Gallery (CCO)</option>
                <option value="dam">Digital Assets (DAM)</option>
              </select>
            </div>
            <hr>
            <div class="form-check mb-2">
              <input type="checkbox" id="setAsDefault" class="form-check-input">
              <label class="form-check-label" for="setAsDefault">
                <i class="bi bi-star text-warning me-1"></i>Set as default for this source type
              </label>
            </div>
            <div class="alert alert-info py-2 small" id="saveInfoAlert">
              <i class="bi bi-info-circle me-1"></i>Enter a new name to create, or select existing to overwrite.
            </div>
            <div class="alert alert-warning py-2 small d-none" id="overwriteWarning">
              <i class="bi bi-exclamation-triangle me-1"></i>This will overwrite: <strong id="overwriteName"></strong>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-outline-secondary" id="clearSelection">Clear Selection</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmSaveMapping"><i class="bi bi-save me-1"></i>Save</button>
      </div>
    </div>
  </div>
</div>
<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">‚úé Rename Mapping</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="renameId">
        <input type="text" id="renameName" class="form-control" placeholder="New name...">
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="confirmRename">Rename</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div class="bg-white rounded p-4 text-center shadow">
    <div class="spinner-border text-primary mb-2"></div>
    <div id="loadingText">Processing...</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var loadModal = new bootstrap.Modal(document.getElementById('loadMappingModal'));
  var saveModal = new bootstrap.Modal(document.getElementById('saveMappingModal'));
  var renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
  
  // Output mode sync
  document.getElementById('outputMode').addEventListener('change', function() {
    document.getElementById('outputModeInput').value = this.value;
  });

  // Toggle AHG fields visibility based on output mode
  function toggleAhgFields() {
    var mode = document.getElementById("outputMode").value;
    var showAhg = (mode === "ahg_csv" || mode === "ahg_import");
    
    // Show/hide the AHG optgroup and options in dropdowns
    document.querySelectorAll("select.atom-field-select").forEach(function(select) {
      var ahgOptgroup = select.querySelector("optgroup.ahg-fields-group");
      if (ahgOptgroup) {
        ahgOptgroup.style.display = showAhg ? "" : "none";
      }
      
      select.querySelectorAll("option").forEach(function(opt) {
        var isAhgField = opt.value && (
          opt.value.startsWith("ahg") ||
          opt.value === "Filename" ||
          (opt.value.startsWith("digitalObject") &&
           opt.value !== "digitalObjectPath" &&
           opt.value !== "digitalObjectURI")
        );
        if (isAhgField) {
          opt.style.display = showAhg ? "" : "none";
          if (!showAhg && opt.selected) {
            select.value = "";
          }
        }
      });
    });
    
    // Show/hide separator rows (table-secondary class)
    document.querySelectorAll("#mappingTable tr.table-secondary, #mappingTable tr.table-warning").forEach(function(row) {
      row.style.display = showAhg ? "" : "none";
    });
    
    // Show/hide AHG source field rows
    document.querySelectorAll("#mappingTable tr[data-row]").forEach(function(row) {
      var sourceField = row.querySelector("code");
      if (sourceField) {
        var fieldName = sourceField.textContent.toLowerCase();
        var isAhgSource = (
          fieldName.startsWith("ahg") ||
          fieldName === "securitydescriptor" ||
          fieldName === "filename" ||
          fieldName.startsWith("digitalobjectchecksum") ||
          fieldName.startsWith("digitalobjectmime") ||
          fieldName.startsWith("digitalobjectsize") ||
          fieldName === "allfilenames" ||
          fieldName.startsWith("transfer_")
        );
        if (isAhgSource) {
          row.style.display = showAhg ? "" : "none";
        }
      }
    });
    
    // Show/hide the AHG info alert
    var ahgInfo = document.getElementById("ahgFieldsInfo");
    if (ahgInfo) {
      ahgInfo.style.display = showAhg ? "none" : "";
    }
  }
  
  // Run on page load and output mode change
  toggleAhgFields();
  document.getElementById("outputMode").addEventListener("change", toggleAhgFields);

  // Mode toggle buttons
  document.getElementById("btnStandardMode").addEventListener("click", function() {
    this.classList.remove("btn-outline-primary");
    this.classList.add("btn-primary", "active");
    document.getElementById("btnAhgMode").classList.remove("btn-info", "active");
    document.getElementById("btnAhgMode").classList.add("btn-outline-info");
    
    // Set dropdown to standard option
    var outputMode = document.getElementById("outputMode");
    if (outputMode.value === "ahg_csv" || outputMode.value === "ahg_import") {
      outputMode.value = "csv";
    }
    document.getElementById("outputModeInput").value = outputMode.value;
    toggleAhgFields();
  });
  
  document.getElementById("btnAhgMode").addEventListener("click", function() {
    this.classList.remove("btn-outline-info");
    this.classList.add("btn-info", "active");
    document.getElementById("btnStandardMode").classList.remove("btn-primary", "active");
    document.getElementById("btnStandardMode").classList.add("btn-outline-primary");
    
    // Set dropdown to AHG option
    var outputMode = document.getElementById("outputMode");
    if (outputMode.value !== "ahg_csv" && outputMode.value !== "ahg_import") {
      outputMode.value = "ahg_csv";
    }
    document.getElementById("outputModeInput").value = outputMode.value;
    toggleAhgFields();
  });
  
  // Sync buttons when dropdown changes
  document.getElementById("outputMode").addEventListener("change", function() {
    var isAhg = (this.value === "ahg_csv" || this.value === "ahg_import");
    var btnStd = document.getElementById("btnStandardMode");
    var btnAhg = document.getElementById("btnAhgMode");
    
    if (isAhg) {
      btnAhg.classList.remove("btn-outline-info");
      btnAhg.classList.add("btn-info", "active");
      btnStd.classList.remove("btn-primary", "active");
      btnStd.classList.add("btn-outline-primary");
    } else {
      btnStd.classList.remove("btn-outline-primary");
      btnStd.classList.add("btn-primary", "active");
      btnAhg.classList.remove("btn-info", "active");
      btnAhg.classList.add("btn-outline-info");
    }
  });
  

  // Custom Field Row Management
  var customFieldCount = 0;
  var totalFieldCount = <?php echo count($mappingRows) ?>;
  
  document.getElementById("addCustomFieldBtn").addEventListener("click", function() {
    customFieldCount++;
    var rowIndex = totalFieldCount + customFieldCount;
    var mode = document.getElementById("outputMode").value;
    var showAhg = (mode === "ahg_csv" || mode === "ahg_import");
    
    var newRow = document.createElement("tr");
    newRow.setAttribute("data-row", rowIndex);
    newRow.setAttribute("data-custom", "true");
    newRow.className = "table-info";
    newRow.innerHTML = `
      <td style="width:16%">
        <input type="hidden" name="fields[${rowIndex}][source_field]" value="_custom_${customFieldCount}" class="custom-source-hidden">
        <input type="text" class="form-control form-control-sm custom-source-input" placeholder="Field name or leave empty..." style="font-family:monospace; font-size:0.8rem;">
        <small class="text-muted">Optional source name</small>
      </td>
      <td style="width:16%">
        <select name="fields[${rowIndex}][atom_field]" class="form-select form-select-sm atom-field-select">
          <option value="">-- Select Target --</option>
          <optgroup label="Standard ISAD-G Fields">
            <?php foreach ($targetFields as $key => $label): ?>
              <?php if (strpos($key, "ahg") !== 0 && $key !== "Filename" && strpos($key, "digitalObject") !== 0 || $key === "digitalObjectPath" || $key === "digitalObjectURI"): ?>
            <option value="<?php echo $key ?>"><?php echo htmlspecialchars($label) ?></option>
              <?php endif ?>
            <?php endforeach ?>
          </optgroup>
          <optgroup label="‚îÄ‚îÄ‚îÄ AHG Extended Fields ‚îÄ‚îÄ‚îÄ" class="ahg-fields-group" ${showAhg ? "" : "style=display:none"}>
            <?php foreach ($targetFields as $key => $label): ?>
              <?php if (strpos($key, "ahg") === 0 || ($key === "Filename" || (strpos($key, "digitalObject") === 0 && $key !== "digitalObjectPath" && $key !== "digitalObjectURI"))): ?>
            <option value="<?php echo $key ?>" ${showAhg ? "" : "style=display:none"}><?php echo htmlspecialchars($label) ?></option>
              <?php endif ?>
            <?php endforeach ?>
          </optgroup>
        </select>
      </td>
      <td style="width:16%">
        <input type="text" name="fields[${rowIndex}][constant_value]" class="form-control form-control-sm" placeholder="Value (e.g., en, English)">
      </td>
      <td style="width:8%" class="text-center">
        <input type="checkbox" name="fields[${rowIndex}][concat_constant]" value="1" class="form-check-input" checked>
      </td>
      <td style="width:8%" class="text-center">
        <input type="checkbox" name="fields[${rowIndex}][concatenate]" value="1" class="form-check-input">
      </td>
      <td style="width:12%">
        <select name="fields[${rowIndex}][concat_symbol]" class="form-select form-select-sm">
          <option value="|">| (Pipe)</option>
          <option value=";">; (Semicolon)</option>
          <option value=",">, (Comma)</option>
          <option value="\n">New line</option>
          <option value=" ">Space</option>
        </select>
      </td>
      <td style="width:6%" class="text-center">
        <input type="checkbox" name="fields[${rowIndex}][include]" value="1" class="form-check-input" checked>
      </td>
      <td style="width:10%">
        <button type="button" class="btn btn-sm btn-outline-danger remove-custom-field">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
    
    // Insert before the Add button row
    document.getElementById("addFieldRow").before(newRow);
    
    // Update hidden source field when user types
    newRow.querySelector(".custom-source-input").addEventListener("input", function() {
      var hidden = newRow.querySelector(".custom-source-hidden");
      hidden.value = this.value || "_custom_" + customFieldCount;
    });
  });
  
  // Remove custom field row
  document.getElementById("mappingTable").addEventListener("click", function(e) {
    if (e.target.closest(".remove-custom-field")) {
      e.target.closest("tr").remove();
    }
  });
  // Target sector sync
  document.getElementById('targetSector').addEventListener('change', function() {
    document.getElementById('targetSectorInput').value = this.value;
  });
  
  // Open Load Mapping Modal
  document.getElementById('loadMappingBtn').addEventListener('click', function() {
    loadModal.show();
  });

  // Load Mapping - click on Load button in modal
  document.querySelectorAll(".load-mapping-btn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      var id = this.dataset.id;
      showLoading("Loading mapping...");
      
      fetch("<?php echo url_for(["module" => "dataMigration", "action" => "loadMapping"]) ?>?id=" + id)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          console.log("Load result:", data);
          if (data.success && data.mapping && data.mapping.fields) {
            var appliedCount = applyMapping(data.mapping.fields);
            hideLoading();
            loadModal.hide();
            var total = data.mapping.fields.length;
            var msg = "Applied " + appliedCount + " of " + total + " field mappings";
            if (appliedCount < total) {
              msg += " (some source fields not in current file)";
            }
            showToast(msg, appliedCount > 0 ? "success" : "warning");
          } else {
            hideLoading();
            showToast("Error: " + (data.error || "No fields found"), "danger");
          }
        })
        .catch(function(e) {
          hideLoading();
          showToast("Error loading mapping: " + e.message, "danger");
        });
    });
  });
  
  // Open Save Mapping Modal
  // Open Save Mapping Modal
  document.getElementById("saveMappingBtn").addEventListener("click", function() {
    document.getElementById("mappingName").value = "";
    document.getElementById("selectedMappingId").value = "";
    document.getElementById("setAsDefault").checked = false;
    document.getElementById("saveInfoAlert").classList.remove("d-none");
    document.getElementById("overwriteWarning").classList.add("d-none");
    document.querySelectorAll(".mapping-select-item").forEach(function(item) {
      item.classList.remove("active", "bg-primary", "text-white");
    });
    saveModal.show();
  });

  // File browser - click to select mapping
  document.querySelectorAll(".mapping-select-item").forEach(function(item) {
    item.addEventListener("click", function() {
      // Remove active from all
      document.querySelectorAll(".mapping-select-item").forEach(function(i) {
        i.classList.remove("active", "bg-primary", "text-white");
      });
      // Add active to this one
      this.classList.add("active", "bg-primary", "text-white");
      
      // Fill in the form
      var id = this.dataset.id;
      var name = this.dataset.name;
      var category = this.dataset.category;
      var isDefault = this.dataset.default === "1";
      
      document.getElementById("selectedMappingId").value = id;
      document.getElementById("mappingName").value = name;
      document.getElementById("setAsDefault").checked = isDefault;
      
      // Set category dropdown
      var catSelect = document.getElementById("mappingCategory");
      for (var i = 0; i < catSelect.options.length; i++) {
        if (catSelect.options[i].value === category) {
          catSelect.selectedIndex = i;
          break;
        }
      }
      
      // Show overwrite warning
      document.getElementById("saveInfoAlert").classList.add("d-none");
      document.getElementById("overwriteWarning").classList.remove("d-none");
      document.getElementById("overwriteName").textContent = name;
    });
  });

  // Clear selection button
  document.getElementById("clearSelection").addEventListener("click", function() {
    document.getElementById("selectedMappingId").value = "";
    document.getElementById("mappingName").value = "";
    document.getElementById("setAsDefault").checked = false;
    document.querySelectorAll(".mapping-select-item").forEach(function(item) {
      item.classList.remove("active", "bg-primary", "text-white");
    });
    document.getElementById("saveInfoAlert").classList.remove("d-none");
    document.getElementById("overwriteWarning").classList.add("d-none");
  });

  // Save Mapping
  document.getElementById("confirmSaveMapping").addEventListener("click", function() {
    var name = document.getElementById("mappingName").value.trim();
    var category = document.getElementById("mappingCategory").value;
    var targetType = document.getElementById("mappingTargetType").value;
    var existingId = document.getElementById("selectedMappingId").value;
    var setAsDefault = document.getElementById("setAsDefault").checked ? "1" : "0";
    
    if (!name) {
      alert("Please enter a mapping name");
      return;
    }
    
    // Warn if overwriting
    if (existingId) {
      var selectedItem = document.querySelector(".mapping-select-item[data-id=\"" + existingId + "\"]");
      if (selectedItem && selectedItem.dataset.default === "1") {
        if (!confirm("Warning: This is a default/system mapping. Changes will affect all users. Continue?")) {
          return;
        }
      }
    }
    
    showLoading("Saving mapping...");
    var formData = new FormData(document.getElementById("mappingForm"));
    formData.append("mapping_name", name);
    formData.append("category", category);
    formData.append("target_type", targetType);
    formData.append("existing_id", existingId);
    formData.append("set_as_default", setAsDefault);
    formData.append("overwrite", existingId ? "1" : "0");
    
    fetch("<?php echo url_for(["module" => "dataMigration", "action" => "saveMapping"]) ?>", {
      method: "POST",
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      console.log("Save result:", data);
      hideLoading();
      if (data.success) {
        var msg = data.updated ? "Mapping updated" : "Mapping saved";
        if (setAsDefault === "1") msg += " (set as default)";
        showToast(msg + " (" + data.field_count + " fields)", "success");
        saveModal.hide();
        setTimeout(function() { location.reload(); }, 1000);
      } else if (data.error === "exists") {
        if (confirm(data.message + " Overwrite?")) {
          document.getElementById("selectedMappingId").value = data.existing_id || "";
          document.getElementById("confirmSaveMapping").click();
        }
      } else {
        showToast("Error: " + (data.error || "Unknown"), "danger");
      }
    })
    .catch(function(e) {
      hideLoading();
      showToast("Error saving: " + e.message, "danger");
    });
  });

  // Rename
  document.querySelectorAll('.rename-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('renameId').value = this.dataset.id;
      document.getElementById('renameName').value = this.dataset.name;
      renameModal.show();
    });
  });
  
  document.getElementById('confirmRename').addEventListener('click', function() {
    var id = document.getElementById('renameId').value;
    var name = document.getElementById('renameName').value.trim();
    if (!name) { alert('Please enter a name'); return; }
    
    fetch('<?php echo url_for(['module' => 'dataMigration', 'action' => 'renameMapping']) ?>?id=' + id + '&name=' + encodeURIComponent(name))
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'Unknown'));
        }
      });
  });
  
  // Delete
  document.querySelectorAll('.delete-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (!confirm('Delete "' + this.dataset.name + '"?')) return;
      
      fetch('<?php echo url_for(['module' => 'dataMigration', 'action' => 'deleteMapping']) ?>?id=' + this.dataset.id)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown'));
          }
        });
    });
  });
});

function applyMapping(fields) {
  console.log('=== APPLYING MAPPING ===');
  console.log('Fields received:', fields.length);
  console.log('First 3 fields:', fields.slice(0, 3));
  
  // Temporarily show all hidden options so we can set their values
  document.querySelectorAll("select.atom-field-select option").forEach(function(opt) {
    opt.removeAttribute("data-was-hidden");
    if (opt.style.display === "none") {
      opt.setAttribute("data-was-hidden", "true");
      opt.style.display = "";
    }
  });
  document.querySelectorAll("select.atom-field-select optgroup").forEach(function(og) {
    og.removeAttribute("data-was-hidden");
    if (og.style.display === "none") {
      og.setAttribute("data-was-hidden", "true");
      og.style.display = "";
    }
  });
  
  // Build lookup by source field
  var map = {};
  fields.forEach(function(f) {
    var key = f.source_field || f.source;
    if (key) {
      map[key] = f;
    }
  });
  
  console.log('Map keys:', Object.keys(map));
  
  // Get all source fields from current form
  var formSourceFields = [];
  document.querySelectorAll('#mappingTable tbody tr input[type="hidden"]').forEach(function(input) {
    formSourceFields.push(input.value);
  });
  console.log('Form source fields:', formSourceFields.slice(0, 5), '... total:', formSourceFields.length);
  
  var applied = 0;
  var notFound = [];
  
  document.querySelectorAll('#mappingTable tbody tr').forEach(function(row) {
    var input = row.querySelector('input[type="hidden"]');
    if (!input) return;
    
    var source = input.value;
    var m = map[source];
    
      console.log("Processing row:", source, "-> looking for mapping");
    if (m) {
      // Apply atom field
      var atomField = m.atom_field || m.atom || '';
      console.log("Found mapping for", source, "-> atom_field:", atomField);
      var atomSelect = row.querySelector('.atom-field-select');
      if (atomSelect) {
        if (atomField) {
          atomSelect.value = atomField;
          console.log("Setting dropdown for", source, "from", atomSelect.value, "to", atomField);
          console.log("Dropdown options:", Array.from(atomSelect.options).map(o => o.value).slice(0,10));
          if (atomSelect.value === atomField) {
            applied++;
            row.classList.add('table-success'); // Highlight applied rows
            row.style.cssText = 'background-color: #d4edda !important';
          } else {
            console.warn('Could not set', source, 'to', atomField, '- value not in dropdown');
            row.classList.add('table-warning');
          }
        }
      }
      
      // Apply constant
      var constInput = row.querySelector('input[name*="constant_value"]');
      if (constInput) constInput.value = m.constant_value || m.constant || '';
      
      // Apply prepend checkbox
      var prependCb = row.querySelector('input[name*="concat_constant"]');
      if (prependCb) prependCb.checked = (m.concat_constant === true || m.concat_constant === 'true' || m.concat_constant === 1);
      
      // Apply concatenate checkbox  
      var concatCb = row.querySelector('input[name*="concatenate"]');
      if (concatCb) concatCb.checked = (m.concatenate === true || m.concatenate === 'true' || m.concatenate === 1);
      
      // Apply concat symbol
      var symbolSel = row.querySelector('select[name*="concat_symbol"]');
      if (symbolSel && m.concat_symbol) symbolSel.value = m.concat_symbol;
      
      // Apply include checkbox
      var includeCb = row.querySelector('.include-check');
      if (includeCb) includeCb.checked = (m.include !== false && m.include !== 'false' && m.include !== 0);
    } else {
      notFound.push(source);
    }
  });
  
  console.log('Applied to', applied, 'fields');
  if (notFound.length > 0 && notFound.length < 20) {
    console.log("Not found in mapping:", notFound.length, "fields");
  }

  // Handle custom fields (fields that start with _custom_ or have no source match)
  
  // Handle custom fields (fields that start with _custom_ or have no source match)
  var customFieldsToAdd = [];
  fields.forEach(function(f) {
    var sourceField = f.source_field || f.source || "";
    // Check if this is a custom field that needs to be added
    if (sourceField.startsWith("_custom_") || (sourceField === "" && f.atom_field)) {
      customFieldsToAdd.push(f);
    }
  });
  console.log("Custom fields check - found:", customFieldsToAdd.length, "fields:", customFieldsToAdd);
  
  // Add custom fields as new rows
  if (customFieldsToAdd.length > 0) {
    console.log("Adding", customFieldsToAdd.length, "custom fields");
    customFieldsToAdd.forEach(function(f) {
      // Simulate clicking the Add Custom Field button
      var addBtn = document.getElementById("addCustomFieldBtn");
      if (addBtn) {
        addBtn.click();
        // Get the newly added row (last row before addFieldRow)
        var newRow = document.getElementById("addFieldRow").previousElementSibling;
        if (newRow) {
          // Set the values
          var sourceInput = newRow.querySelector(".custom-source-input");
          if (sourceInput) sourceInput.value = f.source_field || "";
          
          var hiddenInput = newRow.querySelector(".custom-source-hidden");
          if (hiddenInput) hiddenInput.value = f.source_field || "_custom_loaded";
          
          var atomSelect = newRow.querySelector(".atom-field-select");
          if (atomSelect && f.atom_field) {
            atomSelect.value = f.atom_field;
          }
          
          var constInput = newRow.querySelector("input[name*=\"constant_value\"]");
          if (constInput) constInput.value = f.constant_value || "";
          
          var prependCb = newRow.querySelector("input[name*=\"concat_constant\"]");
          if (prependCb) prependCb.checked = (f.concat_constant === true);
          
          var concatCb = newRow.querySelector("input[name*=\"concatenate\"]");
          if (concatCb) concatCb.checked = (f.concatenate === true);
          
          var includeCb = newRow.querySelector("input[name*=\"include\"]");
          if (includeCb) includeCb.checked = (f.include !== false);
          
          applied++;
        }
      }
    });
  }
  
  console.log("Applied to", applied, "fields (including", customFieldsToAdd.length, "custom fields)");
  if (notFound.length > 0 && notFound.length < 20) {
    console.log("Not found in mapping:", notFound);
  } else if (notFound.length >= 20) {
    console.log("Not found in mapping:", notFound.length, "fields");
  }
  console.log("=== END APPLYING MAPPING ===");
  
  return applied;
}

function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'Processing...';
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

function showToast(message, type) {
  var existing = document.querySelector('.toast-container');
  if (existing) existing.remove();
  
  var div = document.createElement('div');
  div.className = 'toast-container position-fixed top-0 end-0 p-3';
  div.style.zIndex = '10000';
  div.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show mb-0">' +
    message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
  document.body.appendChild(div);
  setTimeout(function() { div.remove(); }, 4000);
}
</script>

<!-- Path Transform Modal -->
<div class="modal fade" id="pathTransformModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">üîÑ Path Transformation Settings</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Transform file paths from source system format to AtoM format.</p>
        
        <div class="mb-3">
          <label class="form-label">Transform Type</label>
          <select id="transformType" class="form-select">
            <option value="">No transformation</option>
            <option value="filename">Extract filename only</option>
            <option value="replace_prefix">Replace path prefix</option>
            <option value="add_prefix">Add prefix to path</option>
            <option value="lowercase">Convert to lowercase</option>
            <option value="extension">Change file extension</option>
          </select>
        </div>
        
        <div id="transformOptions" class="d-none">
          <div class="mb-3" id="replacePrefixGroup">
            <label class="form-label">Find (path to remove)</label>
            <input type="text" id="transformFind" class="form-control" placeholder="C:\Vernon\Images\">
            <small class="text-muted">e.g., C:\Vernon\Images\ or /mnt/media/</small>
          </div>
          
          <div class="mb-3" id="addPrefixGroup">
            <label class="form-label">Replace with / Add prefix</label>
            <input type="text" id="transformReplace" class="form-control" placeholder="images/">
            <small class="text-muted">e.g., images/ or media/photos/</small>
          </div>
          
          <div class="mb-3" id="extensionGroup" class="d-none">
            <label class="form-label">New extension</label>
            <input type="text" id="transformExtension" class="form-control" placeholder=".jpg">
          </div>
        </div>
        
        <div class="card bg-light mt-3">
          <div class="card-body py-2">
            <h6 class="small mb-2">Preview</h6>
            <div class="small">
              <strong>Before:</strong> <code id="transformBefore">C:\Vernon\Images\photo001.tif</code><br>
              <strong>After:</strong> <code id="transformAfter">images/photo001.tif</code>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="applyTransform">Apply to Selected Fields</button>
      </div>
    </div>
  </div>
</div>

<script>
// Path transformation logic
document.getElementById('transformType')?.addEventListener('change', function() {
  var opts = document.getElementById('transformOptions');
  var replaceGroup = document.getElementById('replacePrefixGroup');
  var addGroup = document.getElementById('addPrefixGroup');
  var extGroup = document.getElementById('extensionGroup');
  
  opts.classList.remove('d-none');
  replaceGroup.classList.add('d-none');
  addGroup.classList.add('d-none');
  extGroup.classList.add('d-none');
  
  switch(this.value) {
    case 'replace_prefix':
      replaceGroup.classList.remove('d-none');
      addGroup.classList.remove('d-none');
      break;
    case 'add_prefix':
      addGroup.classList.remove('d-none');
      break;
    case 'extension':
      extGroup.classList.remove('d-none');
      break;
    case 'filename':
    case 'lowercase':
    case '':
      opts.classList.add('d-none');
      break;
  }
  updateTransformPreview();
});

document.getElementById('transformFind')?.addEventListener('input', updateTransformPreview);
document.getElementById('transformReplace')?.addEventListener('input', updateTransformPreview);
document.getElementById('transformExtension')?.addEventListener('input', updateTransformPreview);

function updateTransformPreview() {
  var type = document.getElementById('transformType').value;
  var find = document.getElementById('transformFind').value;
  var replace = document.getElementById('transformReplace').value;
  var ext = document.getElementById('transformExtension').value;
  
  var before = 'C:\\Vernon\\Images\\photo001.tif';
  var after = before;
  
  switch(type) {
    case 'filename':
      after = before.split(/[\\\/]/).pop();
      break;
    case 'replace_prefix':
      if (find) {
        after = before.replace(find, replace || '');
      }
      break;
    case 'add_prefix':
      var filename = before.split(/[\\\/]/).pop();
      after = (replace || '') + filename;
      break;
    case 'lowercase':
      after = before.toLowerCase();
      break;
    case 'extension':
      if (ext) {
        after = before.replace(/\.[^.]+$/, ext);
      }
      break;
  }
  
  // Normalize slashes
  after = after.replace(/\\/g, '/');
  
  document.getElementById('transformBefore').textContent = before;
  document.getElementById('transformAfter').textContent = after;
}

// Store transform settings per field
var fieldTransforms = {};

document.querySelectorAll('.transform-select')?.forEach(function(sel) {
  sel.addEventListener('change', function() {
    if (this.value === 'replace' || this.value === 'prefix') {
      // Open modal for detailed settings
      var row = this.closest('tr');
      var fieldName = row.querySelector('input[type="hidden"]').value;
      document.getElementById('currentTransformField').value = fieldName;
      new bootstrap.Modal(document.getElementById('pathTransformModal')).show();
    }
  });
});
</script>

<!-- Path Transform Modal -->
<div class="modal fade" id="pathTransformModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">üîÑ Path Transformation Settings</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Transform file paths from source system format to AtoM format.</p>
        
        <div class="mb-3">
          <label class="form-label">Transform Type</label>
          <select id="transformType" class="form-select">
            <option value="">No transformation</option>
            <option value="filename">Extract filename only</option>
            <option value="replace_prefix">Replace path prefix</option>
            <option value="add_prefix">Add prefix to path</option>
            <option value="lowercase">Convert to lowercase</option>
            <option value="extension">Change file extension</option>
          </select>
        </div>
        
        <div id="transformOptions" class="d-none">
          <div class="mb-3" id="replacePrefixGroup">
            <label class="form-label">Find (path to remove)</label>
            <input type="text" id="transformFind" class="form-control" placeholder="C:\Vernon\Images\">
            <small class="text-muted">e.g., C:\Vernon\Images\ or /mnt/media/</small>
          </div>
          
          <div class="mb-3" id="addPrefixGroup">
            <label class="form-label">Replace with / Add prefix</label>
            <input type="text" id="transformReplace" class="form-control" placeholder="images/">
            <small class="text-muted">e.g., images/ or media/photos/</small>
          </div>
          
          <div class="mb-3" id="extensionGroup" class="d-none">
            <label class="form-label">New extension</label>
            <input type="text" id="transformExtension" class="form-control" placeholder=".jpg">
          </div>
        </div>
        
        <div class="card bg-light mt-3">
          <div class="card-body py-2">
            <h6 class="small mb-2">Preview</h6>
            <div class="small">
              <strong>Before:</strong> <code id="transformBefore">C:\Vernon\Images\photo001.tif</code><br>
              <strong>After:</strong> <code id="transformAfter">images/photo001.tif</code>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="applyTransform">Apply to Selected Fields</button>
      </div>
    </div>
  </div>
</div>

<script>
// Path transformation logic
document.getElementById('transformType')?.addEventListener('change', function() {
  var opts = document.getElementById('transformOptions');
  var replaceGroup = document.getElementById('replacePrefixGroup');
  var addGroup = document.getElementById('addPrefixGroup');
  var extGroup = document.getElementById('extensionGroup');
  
  opts.classList.remove('d-none');
  replaceGroup.classList.add('d-none');
  addGroup.classList.add('d-none');
  extGroup.classList.add('d-none');
  
  switch(this.value) {
    case 'replace_prefix':
      replaceGroup.classList.remove('d-none');
      addGroup.classList.remove('d-none');
      break;
    case 'add_prefix':
      addGroup.classList.remove('d-none');
      break;
    case 'extension':
      extGroup.classList.remove('d-none');
      break;
    case 'filename':
    case 'lowercase':
    case '':
      opts.classList.add('d-none');
      break;
  }
  updateTransformPreview();
});

document.getElementById('transformFind')?.addEventListener('input', updateTransformPreview);
document.getElementById('transformReplace')?.addEventListener('input', updateTransformPreview);
document.getElementById('transformExtension')?.addEventListener('input', updateTransformPreview);

function updateTransformPreview() {
  var type = document.getElementById('transformType').value;
  var find = document.getElementById('transformFind').value;
  var replace = document.getElementById('transformReplace').value;
  var ext = document.getElementById('transformExtension').value;
  
  var before = 'C:\\Vernon\\Images\\photo001.tif';
  var after = before;
  
  switch(type) {
    case 'filename':
      after = before.split(/[\\\/]/).pop();
      break;
    case 'replace_prefix':
      if (find) {
        after = before.replace(find, replace || '');
      }
      break;
    case 'add_prefix':
      var filename = before.split(/[\\\/]/).pop();
      after = (replace || '') + filename;
      break;
    case 'lowercase':
      after = before.toLowerCase();
      break;
    case 'extension':
      if (ext) {
        after = before.replace(/\.[^.]+$/, ext);
      }
      break;
  }
  
  // Normalize slashes
  after = after.replace(/\\/g, '/');
  
  document.getElementById('transformBefore').textContent = before;
  document.getElementById('transformAfter').textContent = after;
}

// Store transform settings per field
var fieldTransforms = {};

document.querySelectorAll('.transform-select')?.forEach(function(sel) {
  sel.addEventListener('change', function() {
    if (this.value === 'replace' || this.value === 'prefix') {
      // Open modal for detailed settings
      var row = this.closest('tr');
      var fieldName = row.querySelector('input[type="hidden"]').value;
      document.getElementById('currentTransformField').value = fieldName;
      new bootstrap.Modal(document.getElementById('pathTransformModal')).show();
    }
  });
});
</script>

<!-- Background Job Modal -->
<div class="modal fade" id="backgroundJobModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header py-2 bg-success text-white">
        <h6 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>Queue Background Import Job</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">
          Background jobs process imports without browser timeout. Ideal for large files (1000+ rows) or imports with digital objects.
        </p>
        
        <div class="mb-3">
          <label class="form-label">Repository (optional)</label>
          <select id="bgJobRepository" class="form-select">
            <option value="">-- Select Repository --</option>
            <?php
              $repos = QubitRepository::getAll();
              foreach ($repos as $repo):
                if ($repo->id == QubitRepository::ROOT_ID) continue;
            ?>
              <option value="<?php echo $repo->id ?>"><?php echo htmlspecialchars($repo->__toString()) ?></option>
            <?php endforeach ?>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Parent Record (optional)</label>
          <input type="text" id="bgJobParentId" class="form-control" placeholder="Enter parent ID (e.g., 12345)">
          <small class="text-muted">Leave empty to import at top level</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Culture / Language</label>
          <select id="bgJobCulture" class="form-select">
            <option value="en" selected>English</option>
            <option value="af">Afrikaans</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="nl">Dutch</option>
          </select>
        </div>

        <div class="mb-3">
          <div class="form-check">
            <input type="checkbox" id="bgJobUpdate" class="form-check-input">
            <label class="form-check-label" for="bgJobUpdate">Update existing records (match by Legacy ID)</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Digital Objects Path (optional)</label>
          <input type="text" id="bgJobImagePath" class="form-control" placeholder="/path/to/images/">
          <small class="text-muted">Server path where digital objects are located</small>
        </div>

      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="submitBackgroundJob">
          <i class="bi bi-cloud-upload me-1"></i> Queue Job
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Background Job handling
document.getElementById('backgroundJobBtn')?.addEventListener('click', function() {
  new bootstrap.Modal(document.getElementById('backgroundJobModal')).show();
});

document.getElementById('submitBackgroundJob')?.addEventListener('click', function() {
  // Collect mapping data from form
  var form = document.getElementById('mappingForm');
  var formData = new FormData(form);
  
  // Add background job options
  formData.append('repository_id', document.getElementById('bgJobRepository').value);
  formData.append('parent_id', document.getElementById('bgJobParentId').value);
  formData.append('culture', document.getElementById('bgJobCulture').value);
  formData.append('update_existing', document.getElementById('bgJobUpdate').checked ? '1' : '0');
  formData.append('image_path', document.getElementById('bgJobImagePath').value);
  
  // Get saved mapping ID if loaded
  var savedMappingId = document.getElementById('currentMappingId')?.value || '';
  formData.append('saved_mapping_id', savedMappingId);
  
  // Disable button
  var btn = this;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Queueing...';
  
  // Submit to queue action
  fetch('<?php echo url_for(['module' => 'dataMigration', 'action' => 'queueJob']) ?>', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    // Follow redirect
    if (response.redirected) {
      window.location.href = response.url;
    } else {
      return response.text();
    }
  })
  .then(html => {
    if (html) {
      // If not redirected, might be error - reload with message
      window.location.href = '<?php echo url_for(['module' => 'dataMigration', 'action' => 'jobs']) ?>';
    }
  })
  .catch(err => {
    alert('Error queueing job: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i> Queue Job';
  });
});
</script>
