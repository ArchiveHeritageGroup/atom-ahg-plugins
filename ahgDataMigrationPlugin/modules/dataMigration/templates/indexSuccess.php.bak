<?php
/**
 * Data Migration - Upload with Target Type Selection
 * @package ahgDataMigrationPlugin
 */
?>

<div class="container-xxl py-4">
  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="<?php echo url_for(['module' => 'admin', 'action' => 'index']) ?>">Admin</a></li>
          <li class="breadcrumb-item active">Data Migration</li>
        </ol>
      </nav>
      <h1><i class="bi bi-database-up me-2"></i>Data Migration Tool</h1>
      <p class="text-muted">Import data from external systems (ArchivesSpace, Vernon, DB/TextWorks, CSV, XML)</p>
    </div>
  </div>

  <?php if ($sf_user->hasFlash('error')): ?>
    <div class="alert alert-danger alert-dismissible fade show">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <?php echo $sf_user->getFlash('error') ?>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <?php endif ?>

  <?php if ($sf_user->hasFlash('success')): ?>
    <div class="alert alert-success alert-dismissible fade show">
      <i class="bi bi-check-circle me-2"></i>
      <?php echo $sf_user->getFlash('success') ?>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <?php endif ?>

  <form action="<?php echo url_for(['module' => 'dataMigration', 'action' => 'upload']) ?>" method="post" enctype="multipart/form-data">
    <?php echo $form->renderHiddenFields() ?>
    
    <div class="row g-4">
      <!-- Step 1: Target Type Selection -->
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-1-circle me-2"></i>Select Target Record Type</h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-3">What type of records are you importing?</p>
            
            <div class="row g-3">
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_info_object" value="information_object" checked>
                  <label class="form-check-label card h-100" for="target_info_object">
                    <div class="card-body text-center">
                      <i class="bi bi-archive display-4 text-primary mb-2"></i>
                      <h6>Archival Descriptions</h6>
                      <small class="text-muted">ISAD(G) / Information Objects</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_repository" value="repository">
                  <label class="form-check-label card h-100" for="target_repository">
                    <div class="card-body text-center">
                      <i class="bi bi-building display-4 text-success mb-2"></i>
                      <h6>Repositories</h6>
                      <small class="text-muted">ISDIAH / Archival Institutions</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_accession" value="accession">
                  <label class="form-check-label card h-100" for="target_accession">
                    <div class="card-body text-center">
                      <i class="bi bi-inbox display-4 text-warning mb-2"></i>
                      <h6>Accessions</h6>
                      <small class="text-muted">Acquisition Records</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_actor" value="actor">
                  <label class="form-check-label card h-100" for="target_actor">
                    <div class="card-body text-center">
                      <i class="bi bi-people display-4 text-info mb-2"></i>
                      <h6>Authority Records</h6>
                      <small class="text-muted">ISAAR-CPF / Actors</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_subject" value="subject">
                  <label class="form-check-label card h-100" for="target_subject">
                    <div class="card-body text-center">
                      <i class="bi bi-tags display-4 text-secondary mb-2"></i>
                      <h6>Subject Terms</h6>
                      <small class="text-muted">Controlled Vocabulary</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_place" value="place">
                  <label class="form-check-label card h-100" for="target_place">
                    <div class="card-body text-center">
                      <i class="bi bi-geo-alt display-4 text-danger mb-2"></i>
                      <h6>Place Terms</h6>
                      <small class="text-muted">Geographic Access Points</small>
                    </div>
                  </label>
                </div>
              </div>
              
              <div class="col-md-4 col-lg-3">
                <div class="form-check target-type-card">
                  <input class="form-check-input" type="radio" name="target_type" id="target_event" value="event">
                  <label class="form-check-label card h-100" for="target_event">
                    <div class="card-body text-center">
                      <i class="bi bi-calendar-event display-4 text-dark mb-2"></i>
                      <h6>Events</h6>
                      <small class="text-muted">Event Records</small>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: File Upload -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-2-circle me-2"></i>Upload Source File</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label fw-bold">Source File (CSV, XML, JSON)</label>
              <input type="file" class="form-control form-control-lg" name="source_file" accept=".csv,.xml,.json" required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Supported formats: CSV, XML (EAD, Vernon XML), JSON (ArchivesSpace)
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">CSV Delimiter (if CSV)</label>
                <select name="delimiter" class="form-select">
                  <option value="auto">Auto-detect</option>
                  <option value=",">,  (Comma)</option>
                  <option value=";">; (Semicolon)</option>
                  <option value="&#9;">Tab</option>
                  <option value="|">| (Pipe)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">File Encoding</label>
                <select name="encoding" class="form-select">
                  <option value="auto">Auto-detect</option>
                  <option value="UTF-8">UTF-8</option>
                  <option value="ISO-8859-1">ISO-8859-1 (Latin-1)</option>
                  <option value="Windows-1252">Windows-1252</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Mapping Options -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-3-circle me-2"></i>Mapping Options</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label fw-bold">Load Saved Mapping</label>
              <select name="saved_mapping" id="savedMappingSelect" class="form-select">
                <option value="">-- Use Default Mapping --</option>
                <?php if (!empty($savedMappings)): ?>
                  <?php foreach ($savedMappings as $mapping): ?>
                    <option value="<?php echo $mapping->id ?>"><?php echo htmlspecialchars($mapping->name) ?></option>
                  <?php endforeach ?>
                <?php endif ?>
              </select>
              <div class="form-text">
                <i class="bi bi-lightbulb me-1"></i>
                Default mappings loaded based on target type
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Source System Template</label>
              <select name="source_template" class="form-select">
                <option value="">-- No Template --</option>
                <option value="archivesspace">ArchivesSpace Export</option>
                <option value="vernon">Vernon CMS</option>
                <option value="dbtextworks">DB/TextWorks</option>
                <option value="pastperfect">PastPerfect</option>
                <option value="custom">Custom / Other</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="card mt-3">
          <div class="card-body">
            <button type="submit" class="btn btn-primary btn-lg w-100">
              <i class="bi bi-upload me-2"></i>Upload &amp; Map Fields
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Recent Import Jobs -->
  <?php if (!empty($recentJobs)): ?>
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Import Jobs</h5>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Target Type</th>
            <th>Source File</th>
            <th>Records</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($recentJobs as $job): ?>
          <tr>
            <td><?php echo date('Y-m-d H:i', strtotime($job->created_at)) ?></td>
            <td><span class="badge bg-secondary"><?php echo htmlspecialchars($job->target_type) ?></span></td>
            <td><?php echo htmlspecialchars($job->source_file) ?></td>
            <td><?php echo $job->total_records ?></td>
            <td>
              <?php if ($job->status === 'completed'): ?>
                <span class="badge bg-success">Completed</span>
              <?php elseif ($job->status === 'failed'): ?>
                <span class="badge bg-danger">Failed</span>
              <?php else: ?>
                <span class="badge bg-warning">In Progress</span>
              <?php endif ?>
            </td>
            <td>
              <a href="<?php echo url_for(['module' => 'dataMigration', 'action' => 'jobDetails', 'id' => $job->id]) ?>" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye"></i>
              </a>
            </td>
          </tr>
          <?php endforeach ?>
        </tbody>
      </table>
    </div>
  </div>
  <?php endif ?>
</div>

<style>
.target-type-card .form-check-input {
  position: absolute;
  opacity: 0;
}
.target-type-card .card {
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}
.target-type-card .card:hover {
  border-color: var(--bs-primary);
  transform: translateY(-2px);
}
.target-type-card .form-check-input:checked + .card {
  border-color: var(--bs-primary);
  background-color: rgba(var(--bs-primary-rgb), 0.05);
}
.target-type-card .form-check-input:checked + .card i {
  color: var(--bs-primary) !important;
}
</style>
