<?php decorate_with('layout_2col'); ?>

<?php slot('sidebar'); ?>

  <!-- Digital Object / Cover -->
  <div class="card mb-4">
    <div class="card-body text-center">
      <?php if ($digitalObject): ?>
        <?php 
          $fullPath = $digitalObject->path . $digitalObject->name;
          $ext = strtolower(pathinfo($digitalObject->name, PATHINFO_EXTENSION));
          $isImage = in_array($ext, ['jpg', 'jpeg', 'png', 'gif', 'webp']);
        ?>
        <?php if ($isImage): ?>
          <img src="<?php echo esc_entities($fullPath); ?>" alt="" class="img-fluid" style="max-height: 300px;">
        <?php else: ?>
          <div class="p-4">
            <i class="fas fa-file fa-5x text-muted"></i><br>
            <small class="text-muted"><?php echo esc_entities($digitalObject->name); ?></small>
          </div>
        <?php endif; ?>
      <?php elseif ($coverUrl): ?>
        <img src="<?php echo esc_entities($coverUrl); ?>" alt="Cover" class="img-fluid"
             style="max-height: 300px;" onerror="this.parentElement.innerHTML='<i class=\'fas fa-book fa-5x text-muted\'></i>'">
      <?php else: ?>
        <i class="fas fa-book fa-5x text-muted"></i>
      <?php endif; ?>
    </div>
  </div>

  <!-- Digital Object Details -->
  <?php if ($digitalObject && $canEdit): ?>
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-image me-2"></i><?php echo __('Digital object'); ?></h5>
      </div>
      <div class="card-body">
        <table class="table table-sm mb-3">
          <tr>
            <td class="text-muted"><?php echo __('Filename'); ?></td>
            <td><?php echo esc_entities($digitalObject->name); ?></td>
          </tr>
          <tr>
            <td class="text-muted"><?php echo __('Media type'); ?></td>
            <td><?php echo esc_entities($digitalObject->mime_type); ?></td>
          </tr>
        </table>
        
        <!-- Derivatives -->
        <?php if (!empty($derivatives)): ?>
          <h6 class="text-muted mb-2"><?php echo __('Derivatives'); ?></h6>
          <ul class="list-unstyled small">
            <?php foreach ($derivatives as $deriv): ?>
              <li>
                <i class="fas fa-file-image me-1"></i>
                <?php echo esc_entities($deriv->usage_name ?? 'Derivative'); ?>: 
                <?php echo esc_entities($deriv->name); ?>
              </li>
            <?php endforeach; ?>
          </ul>
        <?php endif; ?>
        
        <div class="mt-3">
          <a href="<?php echo url_for([$qubitResource->digitalObjectsRelatedByobjectId[0], 'module' => 'digitalobject', 'action' => 'edit']); ?>" class="btn btn-sm btn-outline-primary w-100 mb-2">
            <i class="fas fa-edit me-1"></i><?php echo __('Edit digital object'); ?>
          </a>
          <a href="<?php echo url_for([$qubitResource->digitalObjectsRelatedByobjectId[0], 'module' => 'digitalobject', 'action' => 'delete']); ?>" class="btn btn-sm btn-outline-danger w-100">
            <i class="fas fa-trash me-1"></i><?php echo __('Delete digital object'); ?>
          </a>
        </div>
      </div>
    </div>
  <?php endif; ?>

  <!-- Quick Info -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><?php echo __('Quick Info'); ?></h5>
    </div>
    <ul class="list-group list-group-flush">
      <?php if ($resource->identifier): ?>
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted"><?php echo __('Identifier'); ?></span>
          <strong><?php echo esc_entities($resource->identifier); ?></strong>
        </li>
      <?php endif; ?>
      <?php if (!empty($libraryData['call_number'])): ?>
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted"><?php echo __('Call #'); ?></span>
          <strong><?php echo esc_entities($libraryData['call_number']); ?></strong>
        </li>
      <?php endif; ?>
      <?php if ($resource->level_name): ?>
        <li class="list-group-item d-flex justify-content-between">
          <span class="text-muted"><?php echo __('Type'); ?></span>
          <span class="badge bg-secondary"><?php echo esc_entities($resource->level_name); ?></span>
        </li>
      <?php endif; ?>
    </ul>
  </div>


  <!-- Collections Management -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><?php echo __('Collections Management'); ?></h5>
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'cco', 'action' => 'provenance', 'slug' => $resource->slug]); ?>"><i class="fas fa-sitemap me-2"></i><?php echo __('Provenance'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'arCondition', 'action' => 'conditionCheck', 'slug' => $resource->slug]); ?>"><i class="fas fa-clipboard-check me-2"></i><?php echo __('Condition assessment'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'spectrum', 'action' => 'index', 'slug' => $resource->slug]); ?>"><i class="fas fa-layer-group me-2"></i><?php echo __('Spectrum data'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'grap', 'action' => 'index', 'slug' => $resource->slug]); ?>"><i class="fas fa-file-invoice-dollar me-2"></i><?php echo __('GRAP data'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'oais', 'action' => 'createSip', 'slug' => $resource->slug]); ?>"><i class="fas fa-archive me-2"></i><?php echo __('Digital Preservation (OAIS)'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'research', 'action' => 'cite', 'slug' => $resource->slug]); ?>"><i class="fas fa-quote-left me-2"></i><?php echo __('Cite this Record'); ?></a></li>
      <li class="list-group-item"><a href="<?php echo url_for(['module' => 'display', 'action' => 'browse']); ?>"><i class="fas fa-th me-2"></i><?php echo __('GLAM browser'); ?></a></li>
    </ul>
  </div>
<?php end_slot(); ?>

<?php slot('title'); ?>
  <h1><?php echo esc_entities($resource->level_name ?? 'Item'); ?> <?php echo esc_entities($resource->identifier); ?> - <?php echo esc_entities($resource->title); ?></h1>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="<?php echo url_for(['module' => 'arLibraryPlugin', 'action' => 'browse']); ?>"><?php echo __('Library'); ?></a></li>
      <li class="breadcrumb-item active"><?php echo esc_entities($resource->title); ?></li>
    </ol>
  </nav>
<?php end_slot(); ?>

<?php slot('content'); ?>

  <!-- Bibliographic Identity -->
  <section class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-book me-2"></i><?php echo __('Bibliographic Identity'); ?></h5>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-3 text-muted"><?php echo __('Title'); ?></div>
        <div class="col-md-9"><strong><?php echo esc_entities($resource->title); ?></strong></div>
      </div>

      <?php if ($resource->identifier): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('Identifier'); ?></div>
          <div class="col-md-9"><?php echo esc_entities($resource->identifier); ?></div>
        </div>
      <?php endif; ?>

      <?php if (!empty($libraryData['call_number'])): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('Call number'); ?></div>
          <div class="col-md-9"><code><?php echo esc_entities($libraryData['call_number']); ?></code></div>
        </div>
      <?php endif; ?>

      <?php if (!empty($libraryData['isbn'])): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('ISBN'); ?></div>
          <div class="col-md-9"><?php echo esc_entities($libraryData['isbn']); ?></div>
        </div>
      <?php endif; ?>

      <?php if (!empty($libraryData['issn'])): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('ISSN'); ?></div>
          <div class="col-md-9"><?php echo esc_entities($libraryData['issn']); ?></div>
        </div>
      <?php endif; ?>

      <?php if (!empty($libraryData['doi'])): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('DOI'); ?></div>
          <div class="col-md-9">
            <a href="https://doi.org/<?php echo esc_entities($libraryData['doi']); ?>" target="_blank">
              <?php echo esc_entities($libraryData['doi']); ?>
            </a>
          </div>
        </div>
      <?php endif; ?>

      <?php if ($resource->level_name): ?>
        <div class="row mb-3">
          <div class="col-md-3 text-muted"><?php echo __('Level'); ?></div>
          <div class="col-md-9"><span class="badge bg-secondary"><?php echo esc_entities($resource->level_name); ?></span></div>
        </div>
      <?php endif; ?>
    </div>
  </section>

  <!-- Publication Information -->
  <?php if (!empty($libraryData['publisher']) || !empty($libraryData['publication_date']) || !empty($libraryData['edition'])): ?>
    <section class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-building me-2"></i><?php echo __('Publication Information'); ?></h5>
      </div>
      <div class="card-body">
        <?php if (!empty($libraryData['publisher'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Publisher'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['publisher']); ?></div>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['publication_place'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Place'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['publication_place']); ?></div>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['publication_date'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Date'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['publication_date']); ?></div>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['edition'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Edition'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['edition']); ?></div>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['series_title'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Series'); ?></div>
            <div class="col-md-9">
              <?php echo esc_entities($libraryData['series_title']); ?>
              <?php if (!empty($libraryData['series_number'])): ?>
                ; <?php echo esc_entities($libraryData['series_number']); ?>
              <?php endif; ?>
            </div>
          </div>
        <?php endif; ?>
      </div>
    </section>
  <?php endif; ?>

  <!-- Physical Description -->
  <?php if (!empty($libraryData['pagination']) || !empty($libraryData['dimensions'])): ?>
    <section class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-ruler me-2"></i><?php echo __('Physical Description'); ?></h5>
      </div>
      <div class="card-body">
        <?php if (!empty($libraryData['pagination'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Pagination'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['pagination']); ?></div>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['dimensions'])): ?>
          <div class="row mb-3">
            <div class="col-md-3 text-muted"><?php echo __('Dimensions'); ?></div>
            <div class="col-md-9"><?php echo esc_entities($libraryData['dimensions']); ?></div>
          </div>
        <?php endif; ?>
      </div>
    </section>
  <?php endif; ?>

  <!-- Content Description -->
  <?php if (!empty($libraryData['summary']) || $resource->scope_and_content || !empty($libraryData['contents_note'])): ?>
    <section class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i><?php echo __('Content Description'); ?></h5>
      </div>
      <div class="card-body">
        <?php if (!empty($libraryData['summary'])): ?>
          <div class="mb-3">
            <h6 class="text-muted"><?php echo __('Summary'); ?></h6>
            <p><?php echo nl2br(esc_entities($libraryData['summary'])); ?></p>
          </div>
        <?php endif; ?>

        <?php if ($resource->scope_and_content): ?>
          <div class="mb-3">
            <h6 class="text-muted"><?php echo __('Scope and content'); ?></h6>
            <p><?php echo nl2br(esc_entities($resource->scope_and_content)); ?></p>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['contents_note'])): ?>
          <div class="mb-3">
            <h6 class="text-muted"><?php echo __('Contents'); ?></h6>
            <p><?php echo nl2br(esc_entities($libraryData['contents_note'])); ?></p>
          </div>
        <?php endif; ?>
      </div>
    </section>
  <?php endif; ?>

  <!-- Notes -->
  <?php if (!empty($libraryData['general_note']) || !empty($libraryData['bibliography_note'])): ?>
    <section class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i><?php echo __('Notes'); ?></h5>
      </div>
      <div class="card-body">
        <?php if (!empty($libraryData['general_note'])): ?>
          <div class="mb-3">
            <h6 class="text-muted"><?php echo __('General note'); ?></h6>
            <p><?php echo nl2br(esc_entities($libraryData['general_note'])); ?></p>
          </div>
        <?php endif; ?>

        <?php if (!empty($libraryData['bibliography_note'])): ?>
          <div class="mb-3">
            <h6 class="text-muted"><?php echo __('Bibliography'); ?></h6>
            <p><?php echo nl2br(esc_entities($libraryData['bibliography_note'])); ?></p>
          </div>
        <?php endif; ?>
      </div>
    </section>
  <?php endif; ?>

  <!-- Action buttons bar -->
  <?php if ($canEdit): ?>
    <section class="actions">
      <ul class="nav nav-pills">
        <li class="nav-item">
          <a class="btn btn-success me-2" href="<?php echo url_for(['module' => 'arLibraryPlugin', 'action' => 'edit', 'slug' => $resource->slug]); ?>">
            <i class="fas fa-edit me-1"></i><?php echo __('Edit'); ?>
          </a>
        </li>
        <li class="nav-item">
          <a class="btn btn-danger me-2" href="<?php echo url_for(['module' => 'informationobject', 'action' => 'delete', 'slug' => $resource->slug]); ?>">
            <i class="fas fa-trash me-1"></i><?php echo __('Delete'); ?>
          </a>
        </li>
        <li class="nav-item">
          <a class="btn btn-primary me-2" href="<?php echo url_for(['module' => 'informationobject', 'action' => 'add', 'parent' => $resource->slug]); ?>">
            <i class="fas fa-plus me-1"></i><?php echo __('Add new'); ?>
          </a>
        </li>
        <li class="nav-item">
          <a class="btn btn-secondary me-2" href="<?php echo url_for(['module' => 'object', 'action' => 'copy', 'slug' => $resource->slug]); ?>">
            <i class="fas fa-copy me-1"></i><?php echo __('Duplicate'); ?>
          </a>
        </li>
        <li class="nav-item">
          <a class="btn btn-secondary me-2" href="<?php echo url_for(['module' => 'default', 'action' => 'move', 'slug' => $resource->slug]); ?>">
            <i class="fas fa-arrows-alt me-1"></i><?php echo __('Move'); ?>
          </a>
        </li>
        <li class="nav-item dropup">
          <a class="btn btn-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <?php echo __('More'); ?>
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'informationobject', 'action' => 'rename', 'slug' => $resource->slug]); ?>"><i class="fas fa-i-cursor me-2"></i><?php echo __('Rename'); ?></a></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'informationobject', 'action' => 'updatePublicationStatus', 'slug' => $resource->slug]); ?>"><i class="fas fa-globe me-2"></i><?php echo __('Update publication status'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'physicalobject', 'action' => 'link', 'slug' => $resource->slug]); ?>"><i class="fas fa-box me-2"></i><?php echo __('Link physical storage'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <?php if ($digitalObject): ?>
              <li><a class="dropdown-item" href="<?php echo url_for([$qubitResource->digitalObjectsRelatedByobjectId[0], 'module' => 'digitalobject', 'action' => 'edit']); ?>"><i class="fas fa-edit me-2"></i><?php echo __('Edit digital object'); ?></a></li>
            <?php else: ?>
              <li><a class="dropdown-item" href="<?php echo url_for([$qubitResource, 'module' => 'object', 'action' => 'addDigitalObject']); ?>"><i class="fas fa-link me-2"></i><?php echo __('Link digital object'); ?></a></li>
            <?php endif; ?>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'informationobject', 'action' => 'multiFileUpload', 'slug' => $resource->slug]); ?>"><i class="fas fa-upload me-2"></i><?php echo __('Import digital objects'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="<?php echo url_for([$qubitResource, 'sf_route' => 'slug/default', 'module' => 'right', 'action' => 'edit']); ?>"><i class="fas fa-balance-scale me-2"></i><?php echo __('Create new rights'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'grap', 'action' => 'index', 'slug' => $resource->slug]); ?>"><i class="fas fa-file-invoice-dollar me-2"></i><?php echo __('View GRAP data'); ?></a></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'grap', 'action' => 'edit', 'slug' => $resource->slug]); ?>"><i class="fas fa-edit me-2"></i><?php echo __('Edit GRAP data'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'spectrum', 'action' => 'index', 'slug' => $resource->slug]); ?>"><i class="fas fa-layer-group me-2"></i><?php echo __('View Spectrum data'); ?></a></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'spectrum', 'action' => 'label', 'slug' => $resource->slug]); ?>"><i class="fas fa-barcode me-2"></i><?php echo __('Generate label'); ?></a></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'cco', 'action' => 'provenance', 'slug' => $resource->slug]); ?>"><i class="fas fa-sitemap me-2"></i><?php echo __('Provenance'); ?></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="<?php echo url_for(['module' => 'spectrum', 'action' => 'workflow', 'slug' => $resource->slug]); ?>"><i class="fas fa-tasks me-2"></i><?php echo __('Workflow Status'); ?></a></li>
          </ul>
        </li>
      </ul>
    </section>
  <?php endif; ?>

<?php end_slot(); ?>
