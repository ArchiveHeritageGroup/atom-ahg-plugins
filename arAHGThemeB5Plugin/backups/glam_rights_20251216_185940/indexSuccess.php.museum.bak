<?php
/**
 * Museum Plugin Index Template
 */

use Illuminate\Database\Capsule\Manager as DB;

// Initialize Laravel if needed
if (\AtomExtensions\Database\DatabaseBootstrap::getCapsule() === null) {
    \AtomExtensions\Database\DatabaseBootstrap::initializeFromAtom();
}

// Get the raw resource (unwrap from escaper)
$rawResource = sfOutputEscaper::unescape($resource);

// Get CCO/Museum data from the ccoData property (stored as JSON)
$museumData = [];
$ccoDataProperty = $rawResource->getPropertyByName('ccoData');

if ($ccoDataProperty) {
    $ccoJson = $ccoDataProperty->getValue(['cultureFallback' => true]);
    if ($ccoJson) {
        $museumData = json_decode($ccoJson, true) ?: [];
    }
}

// Get GRAP data if table exists
$grapData = [];
try {
    $grapData = (array) DB::table('grap_heritage_asset')
        ->where('information_object_id', $rawResource->id)
        ->first();
} catch (Exception $e) {
    // Table may not exist
}

// Headings condition for edit links
$headingsCondition = SecurityPrivileges::editCredentials($sf_user, 'informationObject');
$headingsUrl = ['module' => 'sfMuseumPlugin', 'action' => 'edit', 'slug' => $rawResource->slug];

// Attribution qualifier labels
$attributionLabels = [
    'attributed_to' => 'Attributed to',
    'after' => 'After',
    'follower_of' => 'Follower of',
    'circle_of' => 'Circle of',
    'school_of' => 'School of',
    'studio_of' => 'Studio of',
    'workshop_of' => 'Workshop of',
    'manner_of' => 'Manner of',
    'copy_after' => 'Copy after'
];

// Condition labels
$conditionLabels = [
    'excellent' => 'Excellent',
    'good' => 'Good',
    'fair' => 'Fair',
    'poor' => 'Poor',
    'unknown' => 'Unknown'
];

// Check if field groups have data
$hasObjectIdentification = !empty($museumData['object_number']) || !empty($museumData['work_type']) || !empty($museumData['title_type']);
$hasCreatorInfo = !empty($museumData['creator_display']) || !empty($museumData['creator_role']) || !empty($museumData['attribution_qualifier']);
$hasCreationContext = !empty($museumData['creation_date_display']) || !empty($museumData['creation_place']) || !empty($museumData['culture']) || !empty($museumData['style']) || !empty($museumData['period']);
$hasPhysicalDescription = !empty($museumData['dimensions_display']) || !empty($museumData['materials_display']) || !empty($museumData['materials']) || !empty($museumData['techniques']) || !empty($museumData['support']);
$hasSubjectContent = !empty($museumData['subject_display']) || !empty($museumData['subjects_depicted']) || !empty($museumData['description']);
$hasInscriptions = !empty($museumData['inscriptions']) || !empty($museumData['signature']);
$hasCondition = !empty($museumData['condition_summary']);
$hasProvenance = !empty($museumData['provenance']) || !empty($museumData['current_location']);
?>

<?php decorate_with('layout_3col'); ?>
<?php use_helper('informationobject', 'DigitalObjectViewer'); ?>

<?php slot('sidebar'); ?>
  <?php include_component('informationobject', 'contextMenu'); ?>
<?php end_slot(); ?>

<?php slot('title'); ?>
  <?php echo get_component('informationobject', 'descriptionHeader', ['resource' => $resource, 'title' => (string) $resource]); ?>

  <?php if (QubitInformationObject::ROOT_ID != $resource->parentId) { ?>
    <?php echo include_partial('default/breadcrumb', ['resource' => $resource, 'objects' => $resource->getAncestors()->andSelf()->orderBy('lft')]); ?>
  <?php } ?>

  <?php echo get_component('default', 'translationLinks', ['resource' => $resource]); ?>
<?php end_slot(); ?>

<?php slot('context-menu'); ?>
  <nav>
    <?php echo get_partial('informationobject/actionIcons', ['resource' => $resource]); ?>
    <?php echo get_partial('object/subjectAccessPoints', ['resource' => $resource, 'sidebar' => true]); ?>
    <?php echo get_partial('informationobject/nameAccessPoints', ['resource' => $resource, 'sidebar' => true]); ?>
    <?php echo get_partial('object/placeAccessPoints', ['resource' => $resource, 'sidebar' => true]); ?>
    <?php if (check_field_visibility('app_element_visibility_physical_storage')) { ?>
      <?php echo get_component('physicalobject', 'contextMenu', ['resource' => $resource]); ?>
    <?php } ?>
  </nav>
<?php end_slot(); ?>

<?php slot('before-content'); ?>
  <?php echo get_component('digitalobject', 'imageflow', ['resource' => $resource]); ?>
<?php end_slot(); ?>

<?php // Digital Object Viewer ?>
<?php if (0 < count($resource->digitalObjectsRelatedByobjectId)) { ?>
  <?php foreach ($resource->digitalObjectsRelatedByobjectId as $obj) { ?>
    <?php echo render_digital_object_viewer($resource, $obj); ?>
  <?php } ?>
<?php } ?>

<!-- Identity Area -->
<section id="identityArea" class="border-bottom">
  <?php echo render_b5_section_heading(
      __('Identity area'),
      $headingsCondition,
      $headingsUrl,
      ['anchor' => 'identity-collapse', 'class' => 0 < count($resource->digitalObjectsRelatedByobjectId) ? '' : 'rounded-top']
  ); ?>

  <?php echo render_show(__('Reference code'), $resource->identifier, ['fieldLabel' => 'referenceCode']); ?>
  <?php echo render_show(__('Title'), render_title($resource), ['fieldLabel' => 'title']); ?>

  <div class="field <?php echo render_b5_show_field_css_classes(); ?>">
    <?php echo render_b5_show_label(__('Date(s)')); ?>
    <div class="creationDates <?php echo render_b5_show_value_css_classes(); ?>">
      <ul class="<?php echo render_b5_show_list_css_classes(); ?>">
        <?php foreach ($resource->getDates() as $item) { ?>
          <li>
            <?php echo render_value_inline(Qubit::renderDateStartEnd($item->getDate(['cultureFallback' => true]), $item->startDate, $item->endDate)); ?> (<?php echo $item->getType(['cultureFallback' => true]); ?>)
          </li>
        <?php } ?>
      </ul>
    </div>
  </div>

  <?php echo render_show(__('Level of description'), render_value_inline($resource->levelOfDescription), ['fieldLabel' => 'levelOfDescription']); ?>
</section>

<!-- Context Area -->
<section id="contextArea" class="border-bottom">
  <?php echo render_b5_section_heading(__('Context area'), $headingsCondition, $headingsUrl, ['anchor' => 'context-collapse']); ?>

  <div class="creatorHistories">
    <?php echo get_component('informationobject', 'creatorDetail', ['resource' => $resource]); ?>
  </div>

  <div class="repository">
    <?php echo render_show_repository(__('Repository'), $resource); ?>
  </div>
</section>

<!-- Museum Object Information -->
<section id="museumObjectArea" class="border-bottom">
  <?php echo render_b5_section_heading(__('Museum object information'), $headingsCondition, $headingsUrl, ['anchor' => 'museum-collapse']); ?>

  <?php if (!empty($museumData)) { ?>

    <?php // Object Identification ?>
    <?php if ($hasObjectIdentification) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Object identification'); ?></h4>
      <?php if (!empty($museumData['object_number'])) { echo render_show(__('Object number'), $museumData['object_number']); } ?>
      <?php if (!empty($museumData['work_type'])) { echo render_show(__('Work type'), $museumData['work_type']); } ?>
      <?php if (!empty($museumData['title_type'])) { echo render_show(__('Title type'), $museumData['title_type']); } ?>
    <?php } ?>

    <?php // Creator Information ?>
    <?php if ($hasCreatorInfo) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Creator information'); ?></h4>
      <?php if (!empty($museumData['creator_display'])) { echo render_show(__('Creator (display)'), $museumData['creator_display']); } ?>
      <?php if (!empty($museumData['creator_role'])) { echo render_show(__('Creator role'), $museumData['creator_role']); } ?>
      <?php if (!empty($museumData['attribution_qualifier'])) { echo render_show(__('Attribution'), $attributionLabels[$museumData['attribution_qualifier']] ?? $museumData['attribution_qualifier']); } ?>
    <?php } ?>

    <?php // Creation Context ?>
    <?php if ($hasCreationContext) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Creation context'); ?></h4>
      <?php if (!empty($museumData['creation_date_display'])) { echo render_show(__('Date of creation'), $museumData['creation_date_display']); } ?>
      <?php if (!empty($museumData['creation_place'])) { echo render_show(__('Place of creation'), $museumData['creation_place']); } ?>
      <?php if (!empty($museumData['culture'])) { echo render_show(__('Culture/People'), $museumData['culture']); } ?>
      <?php if (!empty($museumData['style'])) { echo render_show(__('Style'), $museumData['style']); } ?>
      <?php if (!empty($museumData['period'])) { echo render_show(__('Period'), $museumData['period']); } ?>
    <?php } ?>

    <?php // Physical Description ?>
    <?php if ($hasPhysicalDescription) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Physical description'); ?></h4>
      <?php if (!empty($museumData['dimensions_display'])) { echo render_show(__('Dimensions'), $museumData['dimensions_display']); } ?>
      <?php if (!empty($museumData['materials_display'])) { echo render_show(__('Medium/Materials'), $museumData['materials_display']); } ?>
      <?php if (!empty($museumData['materials'])) { echo render_show(__('Materials (indexed)'), $museumData['materials']); } ?>
      <?php if (!empty($museumData['techniques'])) { echo render_show(__('Techniques'), $museumData['techniques']); } ?>
      <?php if (!empty($museumData['support'])) { echo render_show(__('Support'), $museumData['support']); } ?>
    <?php } ?>

    <?php // Subject/Content ?>
    <?php if ($hasSubjectContent) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Subject and content'); ?></h4>
      <?php if (!empty($museumData['subject_display'])) { echo render_show(__('Subject (display)'), $museumData['subject_display']); } ?>
      <?php if (!empty($museumData['subjects_depicted'])) { echo render_show(__('Subjects depicted'), $museumData['subjects_depicted']); } ?>
      <?php if (!empty($museumData['description'])) { echo render_show(__('Description'), $museumData['description']); } ?>
    <?php } ?>

    <?php // Inscriptions/Marks ?>
    <?php if ($hasInscriptions) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Inscriptions and marks'); ?></h4>
      <?php if (!empty($museumData['inscriptions'])) { echo render_show(__('Inscriptions'), $museumData['inscriptions']); } ?>
      <?php if (!empty($museumData['signature'])) { echo render_show(__('Signature'), $museumData['signature']); } ?>
    <?php } ?>

    <?php // Condition ?>
    <?php if ($hasCondition) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Condition'); ?></h4>
      <?php if (!empty($museumData['condition_summary'])) { echo render_show(__('Condition summary'), $conditionLabels[$museumData['condition_summary']] ?? $museumData['condition_summary']); } ?>
    <?php } ?>

    <?php // Provenance/Location ?>
    <?php if ($hasProvenance) { ?>
      <h4 class="h5 mt-3 mb-2 text-muted"><?php echo __('Provenance and location'); ?></h4>
      <?php if (!empty($museumData['provenance'])) { echo render_show(__('Provenance'), $museumData['provenance']); } ?>
      <?php if (!empty($museumData['current_location'])) { echo render_show(__('Current location'), $museumData['current_location']); } ?>
    <?php } ?>

  <?php } else { ?>
    <div class="field">
      <div class="text-muted"><?php echo __('No museum-specific data recorded.'); ?></div>
    </div>
  <?php } ?>
</section>

<!-- GRAP Financial Section -->
<?php if (!empty($grapData)) { ?>
<section id="grapArea" class="border-bottom">
  <?php echo render_b5_section_heading(__('GRAP Financial Compliance'), $headingsCondition, ['module' => 'grap', 'action' => 'edit', 'slug' => $rawResource->slug], ['anchor' => 'grap-collapse']); ?>
  
  <?php if (!empty($grapData['recognition_status'])) { ?>
    <?php $statusLabels = ['recognised' => 'Recognised', 'not_recognised' => 'Not Recognised']; ?>
    <?php echo render_show(__('Recognition status'), $statusLabels[$grapData['recognition_status']] ?? $grapData['recognition_status']); ?>
  <?php } ?>
  
  <?php if (!empty($grapData['initial_recognition_value'])) { ?>
    <?php echo render_show(__('Initial recognition value'), 'R ' . number_format($grapData['initial_recognition_value'], 2)); ?>
  <?php } ?>
  
  <?php if (!empty($grapData['asset_class'])) { ?>
    <?php $classLabels = ['heritage_asset' => 'Heritage Asset', 'operational_asset' => 'Operational Asset', 'investment' => 'Investment']; ?>
    <?php echo render_show(__('Asset class'), $classLabels[$grapData['asset_class']] ?? $grapData['asset_class']); ?>
  <?php } ?>
</section>
<?php } ?>

<!-- Rights Area -->
<?php if ($sf_user->isAuthenticated()) { ?>
<section id="rightsArea" class="border-bottom">
  <?php echo render_b5_section_heading(__('Rights area'), $headingsCondition, $headingsUrl, ['anchor' => 'rights-collapse']); ?>
  <div class="relatedRights">
    <?php echo get_component('right', 'relatedRights', ['resource' => $resource]); ?>
  </div>
</section>
<?php } ?>


<!-- Access Points Area -->
<section id="accessPointsArea" class="border-bottom">
  <?php echo render_b5_section_heading(__('Access points'), $headingsCondition, $headingsUrl, ['anchor' => 'access-collapse']); ?>

  <div class="subjectAccessPoints">
    <?php echo get_partial('object/subjectAccessPoints', ['resource' => $resource]); ?>
  </div>
  <div class="placeAccessPoints">
    <?php echo get_partial('object/placeAccessPoints', ['resource' => $resource]); ?>
  </div>
  <div class="nameAccessPoints">
    <?php echo get_partial('informationobject/nameAccessPoints', ['resource' => $resource, 'showActorEvents' => true]); ?>
  </div>
</section>

<!-- Digital Object Metadata (Access Copies) -->
<?php if (0 < count($resource->digitalObjectsRelatedByobjectId)) { ?>
  <?php echo get_component('digitalobject', 'metadata', ['resource' => $resource->digitalObjectsRelatedByobjectId[0], 'object' => $resource]); ?>
<?php } ?>


<?php slot('after-content'); ?>

  <?php echo get_partial('informationobject/actions', ['resource' => $resource]); ?>
<?php end_slot(); ?>

<?php echo get_component('object', 'gaInstitutionsDimension', ['resource' => $resource]); ?>
