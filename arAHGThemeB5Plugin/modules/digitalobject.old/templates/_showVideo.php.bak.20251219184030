<?php use_helper('Text', 'Media'); ?>

<?php if (QubitTerm::MASTER_ID == $usageType) { ?>

  <?php if (isset($link)) { ?>
    <?php echo image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Original %1% not accessible', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]); ?>
  <?php } else { ?>
    <?php echo link_to(image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Open original %1%', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]), $link); ?>
  <?php } ?>

<?php } elseif (QubitTerm::CHAPTERS_ID == $usageType) { ?>

  <?php // Chapters handled internally by enhanced player ?>

<?php } elseif (QubitTerm::SUBTITLES_ID == $usageType) { ?>

  <?php // Subtitles handled internally by enhanced player ?>

<?php } elseif (QubitTerm::REFERENCE_ID == $usageType) { ?>

  <?php if ($showMediaPlayer) { ?>
    <?php
    // Get the digital object ID for enhanced features
    $digitalObjectId = $resource->id;
    
    // Build digital object data for render function
    $digitalObjectData = [
        'id' => $digitalObjectId,
        'name' => $resource->name,
        'path' => $resource->path,
        'mimeType' => $resource->mimeType,
        'mediaTypeId' => $resource->mediaTypeId ?? null,
        'object_id' => $resource->object->id ?? $resource->objectId ?? 0,
    ];
    
    // Check for existing metadata/transcription
    $hasMetadata = false;
    $hasTranscription = false;
    $transcription = null;
    
    try {
        $metaResult = \Illuminate\Database\Capsule\Manager::selectOne('SELECT id FROM media_metadata WHERE digital_object_id = ?', [$digitalObjectId]);
        $hasMetadata = !empty($metaResult);
        
        $transcription = \Illuminate\Database\Capsule\Manager::selectOne('SELECT * FROM media_transcription WHERE digital_object_id = ?', [$digitalObjectId]);
        $hasTranscription = !empty($transcription);
    } catch (Exception $e) {
        // Tables might not exist
    }
    ?>
    
    <!-- AHG Enhanced Video Player (replaces legacy mediaelement-player) -->
    <?php echo render_enhanced_media_player($digitalObjectData, ['type' => 'video']); ?>
    
    <!-- Action Buttons -->
    <div class="ahg-media-actions mt-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <?php if (!$hasMetadata): ?>
          <button type="button" class="btn btn-sm btn-primary" onclick="extractMetadata(<?php echo $digitalObjectId; ?>)" id="extract-btn-<?php echo $digitalObjectId; ?>">
            <i class="fas fa-cogs"></i> Extract Metadata
          </button>
        <?php endif; ?>
        
        <?php if ($hasTranscription): ?>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#transcript-panel-<?php echo $digitalObjectId; ?>">
            <i class="fas fa-closed-captioning"></i> View Transcript
          </button>
          <a href="/media/transcription/<?php echo $digitalObjectId; ?>/vtt" class="btn btn-sm btn-outline-info" title="Download VTT">
            <i class="fas fa-download"></i> VTT
          </a>
          <a href="/media/transcription/<?php echo $digitalObjectId; ?>/srt" class="btn btn-sm btn-outline-info" title="Download SRT">
            <i class="fas fa-download"></i> SRT
          </a>
          <button type="button" class="btn btn-sm btn-outline-warning" onclick="reTranscribe(<?php echo $digitalObjectId; ?>)" title="Re-transcribe">
            <i class="fas fa-redo"></i> Re-transcribe
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTranscription(<?php echo $digitalObjectId; ?>)" title="Delete transcription">
            <i class="fas fa-trash"></i>
          </button>
        <?php else: ?>
          <button type="button" class="btn btn-sm btn-success" onclick="startTranscription(<?php echo $digitalObjectId; ?>)" id="transcribe-btn-<?php echo $digitalObjectId; ?>">
            <i class="fas fa-microphone"></i> Generate Transcript
          </button>
        <?php endif; ?>
        
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showSnippetCreator(<?php echo $digitalObjectId; ?>)">
          <i class="fas fa-cut"></i> Create Snippet
        </button>
      </div>
    </div>
    
    <!-- Snippets Panel -->
    <div class="snippets-section mt-3">
      <div class="card">
        <div class="card-header py-2">
          <h6 class="mb-0"><i class="fas fa-cut me-2"></i><?php echo __('Video Snippets'); ?></h6>
        </div>
        <div class="card-body py-2" id="snippets-list-<?php echo $digitalObjectId; ?>">
          <?php
          $snippets = [];
          try {
              $snippets = \Illuminate\Database\Capsule\Manager::select('SELECT * FROM media_snippets WHERE digital_object_id = ? ORDER BY start_time', [$digitalObjectId]);
          } catch (Exception $e) {}
          
          if (empty($snippets)): ?>
            <div class="text-muted small">No saved snippets</div>
          <?php else: ?>
            <?php foreach ($snippets as $snippet): ?>
              <div class="snippet-item d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                  <strong><?php echo htmlspecialchars($snippet->title); ?></strong>
                  <div class="small text-muted">
                    <?php echo gmdate("i:s", (int)$snippet->start_time); ?> â†’ <?php echo gmdate("i:s", (int)$snippet->end_time); ?>
                    (<?php echo gmdate("i:s", (int)($snippet->end_time - $snippet->start_time)); ?>)
                  </div>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" onclick="playSnippet(<?php echo $snippet->start_time; ?>, <?php echo $snippet->end_time; ?>)">
                    <i class="fas fa-play"></i>
                  </button>
                  <button class="btn btn-outline-danger" onclick="deleteSnippet(<?php echo $snippet->id; ?>, <?php echo $digitalObjectId; ?>)">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            <?php endforeach; ?>
          <?php endif; ?>
        </div>
      </div>
    </div>
    
    <?php if ($hasTranscription && $transcription): ?>
    <!-- Transcript Panel -->
    <div class="collapse mt-3" id="transcript-panel-<?php echo $digitalObjectId; ?>">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong><i class="fas fa-closed-captioning"></i> Transcript</strong>
          <?php if (!empty($transcription->language)): ?>
            <span class="badge bg-info"><?php echo strtoupper($transcription->language); ?></span>
          <?php endif; ?>
        </div>
        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
          <?php
          $segments = json_decode($transcription->segments ?? '[]', true);
          if (!empty($segments)):
          ?>
            <div class="transcript-segments">
              <?php foreach ($segments as $segment): ?>
                <p class="transcript-segment mb-2"
                   data-start="<?php echo $segment['start'] ?? 0; ?>"
                   onclick="seekToTime(<?php echo $segment['start'] ?? 0; ?>)"
                   style="cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                   onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                  <small class="text-muted">[<?php echo gmdate("i:s", (int)($segment['start'] ?? 0)); ?>]</small>
                  <?php echo htmlspecialchars($segment['text'] ?? ''); ?>
                </p>
              <?php endforeach; ?>
            </div>
          <?php else: ?>
            <p class="mb-0" style="white-space: pre-wrap;"><?php echo htmlspecialchars($transcription->full_text ?? ''); ?></p>
          <?php endif; ?>
        </div>
      </div>
    </div>
    <?php endif; ?>
    
    <!-- Snippet Creator Modal -->
    <div class="modal fade" id="snippetCreatorModal-<?php echo $digitalObjectId; ?>" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-cut me-2"></i><?php echo __('Create Video Snippet'); ?></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label"><?php echo __('Snippet Title'); ?></label>
              <input type="text" class="form-control" id="snippetTitle-<?php echo $digitalObjectId; ?>" placeholder="Enter a title for this snippet">
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label"><?php echo __('Start Time'); ?></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="snippetStart-<?php echo $digitalObjectId; ?>" value="0:00" readonly>
                  <button class="btn btn-outline-secondary" type="button" onclick="setSnippetTime('start', <?php echo $digitalObjectId; ?>)">
                    <i class="fas fa-map-marker-alt"></i> Set
                  </button>
                </div>
              </div>
              <div class="col-6">
                <label class="form-label"><?php echo __('End Time'); ?></label>
                <div class="input-group">
                  <input type="text" class="form-control" id="snippetEnd-<?php echo $digitalObjectId; ?>" value="0:00" readonly>
                  <button class="btn btn-outline-secondary" type="button" onclick="setSnippetTime('end', <?php echo $digitalObjectId; ?>)">
                    <i class="fas fa-flag-checkered"></i> Set
                  </button>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label"><?php echo __('Notes'); ?></label>
              <textarea class="form-control" id="snippetNotes-<?php echo $digitalObjectId; ?>" rows="2" placeholder="Optional notes"></textarea>
            </div>
            <div class="alert alert-info py-2 small mb-0">
              <i class="fas fa-info-circle me-1"></i>
              Play the video to the desired position, then click "Set" to mark start/end times.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSnippet(<?php echo $digitalObjectId; ?>)">
              <i class="fas fa-save me-1"></i>Save Snippet
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
    (function() {
      var doId = <?php echo $digitalObjectId; ?>;
      var snippetData = { startTime: 0, endTime: 0 };
      
      // Get player element
      function getPlayer() {
        return document.getElementById('player-' + doId) || document.querySelector('video');
      }
      
      // Format time
      function formatTime(seconds) {
        var mins = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        return mins + ':' + (secs < 10 ? '0' : '') + secs;
      }
      
      // Snippet functions
      window.showSnippetCreator = function(id) {
        snippetData = { startTime: 0, endTime: 0 };
        document.getElementById('snippetTitle-' + id).value = '';
        document.getElementById('snippetStart-' + id).value = '0:00';
        document.getElementById('snippetEnd-' + id).value = '0:00';
        document.getElementById('snippetNotes-' + id).value = '';
        new bootstrap.Modal(document.getElementById('snippetCreatorModal-' + id)).show();
      };
      
      window.setSnippetTime = function(type, id) {
        var player = getPlayer();
        if (!player) return;
        var time = player.currentTime;
        if (type === 'start') {
          snippetData.startTime = time;
          document.getElementById('snippetStart-' + id).value = formatTime(time);
        } else {
          snippetData.endTime = time;
          document.getElementById('snippetEnd-' + id).value = formatTime(time);
        }
      };
      
      window.saveSnippet = function(id) {
        var title = document.getElementById('snippetTitle-' + id).value.trim();
        var notes = document.getElementById('snippetNotes-' + id).value.trim();
        
        if (!title) { alert('Please enter a title'); return; }
        if (snippetData.startTime >= snippetData.endTime) { alert('End time must be after start time'); return; }
        
        fetch('/media/snippets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            digital_object_id: id,
            title: title,
            start_time: snippetData.startTime,
            end_time: snippetData.endTime,
            notes: notes
          })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('snippetCreatorModal-' + id)).hide();
            location.reload();
          } else {
            alert('Failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(function(err) { alert('Error: ' + err.message); });
      };
      
      window.playSnippet = function(startTime, endTime) {
        var player = getPlayer();
        if (!player) return;
        player.currentTime = startTime;
        player.play();
        var check = setInterval(function() {
          if (player.currentTime >= endTime) { player.pause(); clearInterval(check); }
        }, 100);
      };
      
      window.deleteSnippet = function(snippetId, doId) {
        if (!confirm('Delete this snippet?')) return;
        fetch('/media/snippets/' + snippetId, { method: 'DELETE' })
          .then(function(r) { return r.json(); })
          .then(function(data) { if (data.success) location.reload(); });
      };
      
      window.seekToTime = function(time) {
        var player = getPlayer();
        if (player) { player.currentTime = time; player.play(); }
      };
      
      // Metadata extraction
      window.extractMetadata = function(id) {
        var btn = document.getElementById('extract-btn-' + id);
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting...';
        
        fetch('/media/extract/' + id, { method: 'POST' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success) location.reload();
            else { alert('Error: ' + (data.error || 'Failed')); btn.disabled = false; btn.innerHTML = '<i class="fas fa-cogs"></i> Extract Metadata'; }
          })
          .catch(function(err) { alert('Error'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-cogs"></i> Extract Metadata'; });
      };
      
      // Transcription
      window.startTranscription = function(id) {
        var btn = document.getElementById('transcribe-btn-' + id);
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transcribing...';
        
        fetch('/media/transcribe/' + id, { method: 'POST' })
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.success) location.reload();
            else { alert('Error: ' + (data.error || 'Failed')); btn.disabled = false; btn.innerHTML = '<i class="fas fa-microphone"></i> Generate Transcript'; }
          })
          .catch(function(err) { alert('Error'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-microphone"></i> Generate Transcript'; });
      };
      
      window.reTranscribe = function(id) {
        if (!confirm('Re-transcribe this video? This will replace the existing transcription.')) return;
        startTranscription(id);
      };
      
      window.deleteTranscription = function(id) {
        if (!confirm('Delete this transcription?')) return;
        fetch('/media/transcription/' + id, { method: 'DELETE' })
          .then(function(r) { return r.json(); })
          .then(function(data) { if (data.success) location.reload(); });
      };
    })();
    </script>

  <?php } else { ?>
    <div style="text-align: center">
      <?php echo image_tag($representation->getFullPath(), ['style' => 'border: #999 1px solid', 'alt' => '']); ?>
    </div>
  <?php } ?>

  <?php if (isset($link) && QubitAcl::check($resource->object, 'readMaster')) { ?>
    <div class="mt-2">
      <?php echo link_to(__('Download video'), $link, ['class' => 'btn btn-sm btn-outline-secondary']); ?>
    </div>
  <?php } ?>

<?php } elseif (QubitTerm::THUMBNAIL_ID == $usageType) { ?>

  <?php if ($iconOnly) { ?>
    <?php if (isset($link)) { ?>
      <?php echo link_to(image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Open original %1%', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]), $link); ?>
    <?php } else { ?>
      <?php echo image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Original %1% not accessible', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]); ?>
    <?php } ?>
  <?php } else { ?>
    <div class="digitalObject">
      <div class="digitalObjectRep">
        <?php if (isset($link)) { ?>
          <?php echo link_to(image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Open original %1%', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]), $link); ?>
        <?php } else { ?>
          <?php echo image_tag($representation->getFullPath(), ['alt' => __($resource->getDigitalObjectAltText() ?: 'Original %1% not accessible', ['%1%' => sfConfig::get('app_ui_label_digitalobject')])]); ?>
        <?php } ?>
      </div>
      <div class="digitalObjectDesc">
        <?php echo wrap_text($resource->name, 18); ?>
      </div>
    </div>
  <?php } ?>

<?php } ?>
