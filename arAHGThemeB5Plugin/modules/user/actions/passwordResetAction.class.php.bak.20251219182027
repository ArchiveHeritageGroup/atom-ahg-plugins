<?php

// Load PHPMailer manually (since Composer is not used)
require '/usr/share/nginx/phpmailer/src/PHPMailer.php';
require '/usr/share/nginx/phpmailer/src/SMTP.php';
require '/usr/share/nginx/phpmailer/src/Exception.php';

use PHPMailer\PHPMailer\Exception;
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;

class UserPasswordResetAction extends sfAction
{
    public static $NAMES = [
        'email',
    ];

    public function execute($request)
    {
        $this->form = new sfForm([], [], false);
        $this->form->getValidatorSchema()->setOption('allow_extra_fields', true);
        
        foreach ($this::$NAMES as $name) {
            $this->addField($name);
        }

        // Handle CSRF token
        $csrfToken = $this->form->getCSRFToken();
        if ('' == $csrfToken) {
            $csrfToken = bin2hex(random_bytes(16));
        }

        $defaults = [
            '_csrf_token' => $csrfToken,
        ];

        if ($request->isMethod('post')) {
            $this->form->bind($request->getPostParameters() + $defaults);

            if ($this->form->isValid()) {
                $email = $this->form->getValue('email');
                
                // Find user by email
                $criteria = new Criteria();
                $criteria->add(QubitUser::EMAIL, $email);
                $user = QubitUser::getOne($criteria);

                if ($user) {
                    // Generate reset token
                    $token = bin2hex(random_bytes(32));
                    $expiry = date('Y-m-d H:i:s', strtotime('+1 hour'));
                    
                    // Store token in user object
                    $user->resetToken = $token;
                    $user->resetTokenExpiry = $expiry;
                    $user->save();

                    // Send email
                    $this->sendResetEmail($user, $token);
                    
                    $this->getUser()->setFlash('notice', $this->context->i18n->__('Password reset instructions have been sent to your email.'));
                } else {
                    // Don't reveal if email exists (security best practice)
                    $this->getUser()->setFlash('notice', $this->context->i18n->__('If that email exists, reset instructions have been sent.'));
                }

                $this->redirect(['module' => 'user', 'action' => 'login']);
            }
        } else {
            // Bind defaults for GET request
            $this->form->bind($defaults);
        }
    }

    protected function addField($name)
    {
        switch ($name) {
            case 'email':
                $this->form->setDefault('email', '');
                $this->form->setValidator('email', new sfValidatorEmail(['required' => true]));
                $this->form->setWidget('email', new sfWidgetFormInput());
                break;
        }
    }

    protected function sendResetEmail($user, $token)
    {
        $mail = new PHPMailer(true);

        try {
            // Get email settings from QubitSetting
            $host = QubitSetting::getByNameAndScope('host', 'email');
            $port = QubitSetting::getByNameAndScope('port', 'email');
            $smtp_secure = QubitSetting::getByNameAndScope('smtp_secure', 'email');
            $smtp_auth = QubitSetting::getByNameAndScope('smtp_auth', 'email');
            $username = QubitSetting::getByNameAndScope('email_username', 'email');
            $password = QubitSetting::getByNameAndScope('password', 'email');
            $from = QubitSetting::getByNameAndScope('from', 'email');
            $to = QubitSetting::getByNameAndScope('to', 'email');
            $cc = QubitSetting::getByNameAndScope('cc', 'email');
            $reply_to = QubitSetting::getByNameAndScope('reply_to', 'email');

            // Generate reset URL
            $resetUrl = $this->getController()->genUrl([
                'module' => 'user', 
                'action' => 'passwordResetConfirm',
                'token' => $token
            ], true);

            // Build email body
            $body = "Hello,\n\n";
            $body .= "You requested a password reset for your account.\n\n";
            $body .= "Click the following link to reset your password:\n";
            $body .= $resetUrl . "\n\n";
            $body .= "This link will expire in 1 hour.\n\n";
            $body .= "If you did not request this reset, please ignore this email.\n\n";
            $body .= "Username: " . $user->username . "\n";

            // SMTP Configuration
            $mail->isSMTP();
            $mail->Host = $host;
            $mail->SMTPAuth = true;
            $mail->Username = $username;
            $mail->Password = $password;
            $mail->SMTPSecure = trim(strval($smtp_secure));
            $mail->Port = strval($port);

            $mail->setFrom(trim($from), 'Rock Art Research Institute (RARI)');
            $mail->addAddress($user->email, $user->username);
            $mail->addReplyTo(trim($reply_to), 'Reply');
            
            if (!empty($cc)) {
                $mail->addCC(trim($cc));
            }

            $mail->Subject = 'Password Reset Request';
            $mail->Body = $body;

            // Send email
            $mail->send();
        } catch (Exception $e) {
            // Log error but don't reveal to user for security
            error_log("Password reset email could not be sent. Error: {$mail->ErrorInfo}");
        }
    }
}