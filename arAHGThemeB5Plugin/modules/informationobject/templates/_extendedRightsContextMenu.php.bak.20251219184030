<?php
/**
 * Extended Rights Context Menu Items
 * Add to _contextMenu.php or include as partial
 */

if (!isset($resource) || !$resource->id) {
    return;
}

$canEdit = $sf_user->isAuthenticated() && QubitAcl::check($resource, 'update');

// Check if has extended rights
$hasRights = \Illuminate\Database\Capsule\Manager::table('extended_rights')
    ->where('object_id', $resource->id)
    ->exists();

// Check if has active embargo
$hasEmbargo = \Illuminate\Database\Capsule\Manager::table('embargo')
    ->where('object_id', $resource->id)
    ->where('is_active', true)
    ->exists();
?>

<?php if ($canEdit): ?>
<section id="extended-rights-menu">
  <h4><?php echo __('Rights'); ?></h4>
  <ul class="list-unstyled">
    <li>
      <a href="<?php echo url_for(['module' => 'extendedRights', 'action' => 'edit', 'slug' => $resource->slug]); ?>">
        <i class="fas fa-copyright fa-fw me-1"></i>
        <?php echo $hasRights ? __('Edit extended rights') : __('Add extended rights'); ?>
      </a>
    </li>
    <li>
      <a href="<?php echo url_for(['module' => 'embargo', 'action' => 'edit', 'objectId' => $resource->id]); ?>">
        <i class="fas fa-lock fa-fw me-1"></i>
        <?php echo $hasEmbargo ? __('Manage embargo') : __('Add embargo'); ?>
      </a>
    </li>
    <li>
      <a href="<?php echo url_for(['module' => 'extendedRights', 'action' => 'export', 'id' => $resource->id]); ?>">
        <i class="fas fa-download fa-fw me-1"></i>
        <?php echo __('Export rights (JSON-LD)'); ?>
      </a>
    </li>
  </ul>
</section>
<?php endif; ?>

<?php if ($hasRights || $hasEmbargo): ?>
<section id="rights-status-menu">
  <h4><?php echo __('Rights Status'); ?></h4>
  <ul class="list-unstyled">
    <?php if ($hasRights): ?>
    <li><i class="fas fa-check-circle text-success fa-fw me-1"></i><?php echo __('Has extended rights'); ?></li>
    <?php endif; ?>
    <?php if ($hasEmbargo): ?>
    <li><i class="fas fa-lock text-warning fa-fw me-1"></i><?php echo __('Under embargo'); ?></li>
    <?php endif; ?>
  </ul>
</section>
<?php endif; ?>
