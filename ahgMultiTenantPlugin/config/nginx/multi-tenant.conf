# ============================================================================
# Multi-Tenant Nginx Configuration for AtoM Heratio
# ============================================================================
#
# This configuration enables:
# - Wildcard subdomain routing: {tenant}.heritage.example.com
# - Custom domain support: archive.institution.org
# - SSL for all domains (via Let's Encrypt or manual)
#
# Installation:
# 1. Copy this file to /etc/nginx/conf.d/multi-tenant.conf
# 2. Update the server_name and root paths
# 3. Configure SSL certificates
# 4. Run: nginx -t && systemctl reload nginx
#
# ============================================================================

# ============================================================================
# OPTION 1: Wildcard Subdomain Configuration
# ============================================================================
# Use this for subdomain-based multi-tenancy:
# - tenant1.heritage.example.com
# - tenant2.heritage.example.com
#
# Requirements:
# - Wildcard DNS: *.heritage.example.com -> your server IP
# - Wildcard SSL certificate (e.g., *.heritage.example.com)

server {
    listen 80;
    listen [::]:80;
    server_name *.heritage.example.com heritage.example.com;

    # Redirect HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name *.heritage.example.com heritage.example.com;

    # SSL Configuration - Wildcard Certificate
    ssl_certificate /etc/letsencrypt/live/heritage.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/heritage.example.com/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;

    # Document Root
    root /usr/share/nginx/archive;
    index index.php;

    # AtoM Configuration
    include /usr/share/nginx/archive/atom-framework/config/nginx/extensions.conf;

    location / {
        try_files $uri /index.php?$args;
    }

    location ~ /\. {
        deny all;
        return 404;
    }

    location ~* (\.yml|\.ini|\.sh|\.xml)$ {
        deny all;
        return 404;
    }

    location ~ ^/(apps|cache|data|lib|plugins|test|vendor)/ {
        deny all;
        return 404;
    }

    location ~ ^/index\.php(/|$) {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # Pass tenant info to PHP (optional - for debugging)
        fastcgi_param HTTP_X_TENANT_HOST $host;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
}

# ============================================================================
# OPTION 2: Custom Domain Configuration
# ============================================================================
# Use this for tenant-specific custom domains:
# - archive.nationalarchives.org
# - collections.museum.org
#
# Requirements:
# - Each domain needs its own DNS pointing to server
# - Each domain needs its own SSL certificate
#
# For each custom domain, create a new server block:

server {
    listen 80;
    listen [::]:80;
    server_name archive.institution.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name archive.institution.org;

    # SSL Configuration - Domain-specific certificate
    ssl_certificate /etc/letsencrypt/live/archive.institution.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/archive.institution.org/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    add_header Strict-Transport-Security "max-age=63072000" always;

    root /usr/share/nginx/archive;
    index index.php;

    include /usr/share/nginx/archive/atom-framework/config/nginx/extensions.conf;

    location / {
        try_files $uri /index.php?$args;
    }

    location ~ /\. {
        deny all;
        return 404;
    }

    location ~* (\.yml|\.ini|\.sh|\.xml)$ {
        deny all;
        return 404;
    }

    location ~ ^/(apps|cache|data|lib|plugins|test|vendor)/ {
        deny all;
        return 404;
    }

    location ~ ^/index\.php(/|$) {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param HTTP_X_TENANT_HOST $host;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
}

# ============================================================================
# SSL CERTIFICATE SETUP
# ============================================================================
#
# WILDCARD CERTIFICATE (for subdomains):
# certbot certonly --dns-cloudflare \
#   --dns-cloudflare-credentials ~/.secrets/cloudflare.ini \
#   -d heritage.example.com \
#   -d "*.heritage.example.com"
#
# Or with manual DNS validation:
# certbot certonly --manual --preferred-challenges dns \
#   -d heritage.example.com \
#   -d "*.heritage.example.com"
#
# SINGLE DOMAIN CERTIFICATE (for custom domains):
# certbot certonly --nginx -d archive.institution.org
#
# AUTO-RENEWAL:
# Add to crontab: 0 3 * * * certbot renew --quiet
#
# ============================================================================
