<?php slot('title') ?><?php echo esc_entities($agreement['title'] ?? $agreement['agreement_number']) ?><?php end_slot() ?>
<nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'browse']) ?>"><?php echo __('Agreements') ?></a></li><li class="breadcrumb-item active"><?php echo esc_entities($agreement['agreement_number']) ?></li></ol></nav>
<div class="row"><div class="col-lg-9">
<section class="card mb-4"><div class="card-header"><h2 class="h5 mb-0"><i class="fas fa-file-contract me-2"></i><?php echo __('Agreement Details') ?></h2></div><div class="card-body"><div class="row"><div class="col-md-6"><?php echo render_show(__('Agreement Number'), $agreement['agreement_number']) ?><?php echo render_show(__('Type'), $agreement['agreement_type_name']) ?><?php echo render_show(__('Status'), '<span class="badge bg-' . match($agreement['status']) { 'active' => 'success', 'draft' => 'secondary', 'expired' => 'danger', default => 'info' } . '">' . __(ucwords(str_replace('_', ' ', $agreement['status']))) . '</span>') ?><?php echo render_show(__('Donor'), $agreement['donor_name']) ?></div><div class="col-md-6"><?php echo render_show(__('Agreement Date'), $agreement['agreement_date'] ? format_date($agreement['agreement_date'], 'd') : null) ?><?php echo render_show(__('Effective Date'), $agreement['effective_date'] ? format_date($agreement['effective_date'], 'd') : null) ?><?php echo render_show(__('Expiry Date'), $agreement['expiry_date'] ? format_date($agreement['expiry_date'], 'd') : __('Perpetual')) ?><?php echo render_show(__('Review Date'), $agreement['review_date'] ? format_date($agreement['review_date'], 'd') : null) ?></div></div><?php echo render_show(__('Description'), $agreement['description']) ?><?php echo render_show(__('Scope'), $agreement['scope_description']) ?><?php echo render_show(__('General Terms'), $agreement['general_terms']) ?></div></section>
<section class="card mb-4"><div class="card-header d-flex justify-content-between"><h2 class="h5 mb-0"><i class="fas fa-balance-scale me-2"></i><?php echo __('Rights') ?></h2><span class="badge bg-primary"><?php echo count($agreement['rights']) ?></span></div><div class="card-body p-0"><?php if (!empty($agreement['rights'])): ?><table class="table table-sm mb-0"><thead class="table-light"><tr><th><?php echo __('Right') ?></th><th><?php echo __('Permission') ?></th><th><?php echo __('Conditions') ?></th></tr></thead><tbody><?php foreach ($agreement['rights'] as $r): ?><tr><td><?php echo __(ucwords(str_replace('_', ' ', $r['right_type']))) ?></td><td><span class="badge bg-<?php echo match($r['permission']) { 'granted' => 'success', 'prohibited' => 'danger', default => 'warning' } ?>"><?php echo __(ucfirst($r['permission'])) ?></span></td><td><?php echo esc_entities($r['conditions']) ?></td></tr><?php endforeach ?></tbody></table><?php else: ?><p class="text-muted p-3 mb-0"><?php echo __('No rights specified.') ?></p><?php endif ?></div></section>
<section class="card mb-4"><div class="card-header d-flex justify-content-between"><h2 class="h5 mb-0"><i class="fas fa-lock me-2"></i><?php echo __('Restrictions') ?></h2><span class="badge bg-warning"><?php echo count($agreement['restrictions']) ?></span></div><div class="card-body p-0"><?php if (!empty($agreement['restrictions'])): ?><table class="table table-sm mb-0"><thead class="table-light"><tr><th><?php echo __('Type') ?></th><th><?php echo __('Reason') ?></th><th><?php echo __('Release') ?></th></tr></thead><tbody><?php foreach ($agreement['restrictions'] as $r): ?><tr><td><span class="badge bg-danger"><?php echo __(ucwords(str_replace('_', ' ', $r['restriction_type']))) ?></span></td><td><?php echo esc_entities($r['reason']) ?></td><td><?php echo $r['release_date'] ? format_date($r['release_date'], 'd') : __('Indefinite') ?></td></tr><?php endforeach ?></tbody></table><?php else: ?><p class="text-muted p-3 mb-0"><?php echo __('No restrictions.') ?></p><?php endif ?></div></section>
<section class="card mb-4"><div class="card-header d-flex justify-content-between"><h2 class="h5 mb-0"><i class="fas fa-paperclip me-2"></i><?php echo __('Documents') ?></h2><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'addDocument', 'id' => $agreement['id']]) ?>" class="btn btn-sm btn-outline-primary"><i class="fas fa-upload me-1"></i><?php echo __('Upload') ?></a></div><div class="card-body p-0"><?php if (!empty($agreement['documents'])): ?><div class="list-group list-group-flush"><?php foreach ($agreement['documents'] as $d): ?><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'downloadDocument', 'docId' => $d['id']]) ?>" class="list-group-item list-group-item-action d-flex justify-content-between"><span><i class="fas fa-file me-2"></i><?php echo esc_entities($d['title'] ?: $d['original_filename']) ?><?php if ($d['is_signed']): ?><span class="badge bg-success ms-2"><?php echo __('Signed') ?></span><?php endif ?></span><small class="text-muted"><?php echo format_date($d['created_at'], 'd') ?></small></a><?php endforeach ?></div><?php else: ?><p class="text-muted p-3 mb-0"><?php echo __('No documents.') ?></p><?php endif ?></div></section>
</div><div class="col-lg-3">
<div class="card mb-4"><div class="card-header"><h3 class="h6 mb-0"><?php echo __('Actions') ?></h3></div><div class="list-group list-group-flush"><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'edit', 'id' => $agreement['id']]) ?>" class="list-group-item list-group-item-action"><i class="fas fa-edit me-2"></i><?php echo __('Edit') ?></a><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'addDocument', 'id' => $agreement['id']]) ?>" class="list-group-item list-group-item-action"><i class="fas fa-upload me-2"></i><?php echo __('Upload document') ?></a><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'addReminder', 'id' => $agreement['id']]) ?>" class="list-group-item list-group-item-action"><i class="fas fa-bell me-2"></i><?php echo __('Add reminder') ?></a><?php if ($agreement['status'] === 'active'): ?><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'terminate', 'id' => $agreement['id']]) ?>" class="list-group-item list-group-item-action text-danger"><i class="fas fa-times-circle me-2"></i><?php echo __('Terminate') ?></a><?php endif ?><a href="<?php echo url_for(['module' => 'donorAgreement', 'action' => 'delete', 'id' => $agreement['id']]) ?>" class="list-group-item list-group-item-action text-danger"><i class="fas fa-trash me-2"></i><?php echo __('Delete') ?></a></div></div>
<div class="card mb-4"><div class="card-header d-flex justify-content-between"><h3 class="h6 mb-0"><?php echo __('Reminders') ?></h3><span class="badge bg-secondary"><?php echo count($agreement['reminders']) ?></span></div><div class="card-body p-0"><?php $active = array_filter($agreement['reminders'], fn($r) => $r['status'] === 'active'); ?><?php if (!empty($active)): ?><div class="list-group list-group-flush"><?php foreach (array_slice($active, 0, 5) as $r): ?><div class="list-group-item py-2"><small class="fw-semibold"><?php echo esc_entities($r['title']) ?></small><br><small class="text-muted"><?php echo format_date($r['reminder_date'], 'd') ?></small></div><?php endforeach ?></div><?php else: ?><p class="text-muted p-3 mb-0 small"><?php echo __('No active reminders.') ?></p><?php endif ?></div></div>
</div></div>
